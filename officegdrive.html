<div id="officegdrive-app">
  <h1>Googleドライブビューア</h1>
  <div id="file-ops" style="margin: 10px 0;">
    <button id="nav-up" onclick="navigateUp()">⬆ 上のフォルダへ</button>
    <button onclick="renameFile()">📝 名前変更</button>
    <button onclick="deleteFile()">❌ 削除</button>
    <button onclick="createFolder()">📁 フォルダ作成</button>
    <button onclick="moveFile()">🔀 移動</button>
  </div>
  <div id="drive-list">読み込み中...</div>
</div>

<style>
  #file-ops button {
    margin: 4px;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    background-color: #f0f0f0;
    box-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }
  #file-ops button:hover {
    background-color: #e0e0e0;
  }
  .drive-item.selected {
    background-color: #d0e7ff;
  }

  #officegdrive-app {
    font-family: sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: auto;
  }
  #officegdrive-app h1 {
    font-size: 1.5em;
    margin-bottom: 10px;
  }
  #drive-list {
    border: 1px solid #ccc;
    padding: 10px;
    
    overflow-y: auto;
    background: #f9f9f9;
  }
  .drive-item {
    padding: 5px;
    margin: 4px 0;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
  }
  .drive-item.folder::before {
    content: "📁 ";
  }
  .drive-item.file::before {
    content: "📄 ";
  }
  #nav-up {
    margin-bottom: 10px;
  }
</style>

<script>
// ✅ このアプリを使うには、Google連携時に以下のスコープが必要です：
// https://www.googleapis.com/auth/drive
// https://www.googleapis.com/auth/userinfo.email

(() => {
  const app = document.getElementById("officegdrive-app");
  const driveList = document.getElementById("drive-list");
  const navUp = document.getElementById("nav-up");
  const scopeInfo = document.getElementById("scope-info");

  const userKey = localStorage.getItem("carelayUser") || "";
  const googleToken = localStorage.getItem("carelayGoogleToken_" + userKey);
  let currentFolder = null;
  let selectedFile = null;
  let parentMap = {};

  // スコープの表示
  if (googleToken) {
    fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=" + googleToken)
      .then(res => res.json())
      .then(data => {
        if (data.scope) {
          scopeInfo.textContent = "現在のトークンスコープ: " + data.scope;
        } else {
          scopeInfo.textContent = "スコープ情報を取得できませんでした。";
        }
      })
      .catch(err => {
        scopeInfo.textContent = "トークンスコープの取得に失敗しました。";
        console.error(err);
      });
  } else {
    scopeInfo.textContent = "Google連携されていません。";
  }

  const updateDisplay = () => {
    fetch(`https://www.googleapis.com/drive/v3/files?q='${currentFolder}'+in+parents+and+trashed=false&fields=files(id,name,mimeType,parents)&pageSize=100`, {
      headers: { Authorization: "Bearer " + googleToken }
    })
    .then(res => res.json())
    .then(data => {
      driveList.innerHTML = "";
      if (!data.files || data.files.length === 0) {
        driveList.textContent = "ファイルがありません。";
        return;
      }
      data.files.forEach(file => {
        const div = document.createElement("div");
        div.textContent = file.name;
        div.className = "drive-item " + (file.mimeType === "application/vnd.google-apps.folder" ? "folder" : "file");
        div.onclick = () => {
          if (file.mimeType === "application/vnd.google-apps.folder") {
            parentMap[file.id] = currentFolder;
            currentFolder = file.id;
            updateDisplay();
          } else {
            window.open(`https://drive.google.com/file/d/${file.id}/view`, "_blank");
          }
        };
        driveList.appendChild(div);
      });
    })
    .catch(err => {
      driveList.textContent = "読み込みに失敗しました。連携状態やスコープを確認してください。";
      console.error(err);
    });
  };

  navUp.onclick = () => {
    if (parentMap[currentFolder]) {
      currentFolder = parentMap[currentFolder];
      updateDisplay();
    }
  };

  if (googleToken) {
    fetch("https://www.googleapis.com/drive/v3/about?fields=rootFolderId", {
      headers: { Authorization: "Bearer " + googleToken }
    })
    .then(res => res.json())
    .then(data => {
      currentFolder = data.rootFolderId || 'root';
      updateDisplay();
    })
    .catch(err => {
      driveList.textContent = "ルートフォルダの取得に失敗しました。";
      console.error(err);
    });
  }
})();
</script>
