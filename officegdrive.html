<div id="officegdrive-app">
  <h1 class="text-xl font-bold mb-4">Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
  <div id="file-ops" class="flex flex-wrap gap-2 mb-4">
    <button onclick="navUp.click()" class="btn">â¬† ä¸Šã®ãƒ•ã‚©ãƒ«ãƒ€ã¸</button>
    <button onclick="renameFile()" class="btn">ğŸ“ åå‰å¤‰æ›´</button>
    <button onclick="deleteFile()" class="btn">âŒ å‰Šé™¤</button>
    <button onclick="createFolder()" class="btn">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</button>
    <button onclick="moveFile()" class="btn">ğŸ”€ ç§»å‹•</button>
  </div>
  <div style="margin-bottom: 10px;"></div>
  <div id="drive-list" class="drive-box">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<style>
  #officegdrive-app {
    font-family: sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: auto;
  }
  #officegdrive-app h1 {
    font-size: 1.5em;
    margin-bottom: 10px;
  }
  .drive-box {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    min-height: 300px;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .drive-item {
    padding: 5px;
    margin: 4px 0;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
  }
  .drive-item.folder::before {
    content: "ğŸ“ ";
  }
  .drive-item.file::before {
    content: "ğŸ“„ ";
  }

  .btn {
    background-color: #f8f9fa;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .btn:hover {
    background-color: #e2e6ea;
  }
</style>

<script>
(() => {
  const app = document.getElementById("officegdrive-app");
  const driveList = document.getElementById("drive-list");
  const navUp = document.createElement("button");
  navUp.style.display = "none";
  navUp.onclick = () => {
    if (parentMap[currentFolder]) {
      currentFolder = parentMap[currentFolder];
      updateDisplay();
    }
  };
  document.body.appendChild(navUp);

  const userKey = localStorage.getItem("carelayUser") || "";
  const googleToken = localStorage.getItem("carelayGoogleToken_" + userKey);
  let currentFolder = null;
  let parentMap = {};
  let selectedFileId = null;

  const updateDisplay = () => {
    fetch(`https://www.googleapis.com/drive/v3/files?q='${currentFolder}'+in+parents+and+trashed=false&fields=files(id,name,mimeType,parents)&pageSize=100`, {
      headers: { Authorization: "Bearer " + googleToken }
    })
    .then(res => res.json())
    .then(data => {
      driveList.innerHTML = "";
      if (!data.files || data.files.length === 0) {
        driveList.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }
      data.files.forEach(file => {
        const div = document.createElement("div");
        div.textContent = file.name;
        div.className = "drive-item " + (file.mimeType === "application/vnd.google-apps.folder" ? "folder" : "file");
        div.onclick = () => {
          selectedFileId = file.id;
          if (file.mimeType === "application/vnd.google-apps.folder") {
            parentMap[file.id] = currentFolder;
            currentFolder = file.id;
            updateDisplay();
          } else {
            window.open(`https://drive.google.com/file/d/${file.id}/view`, "_blank");
          }
        };
        driveList.appendChild(div);
      });
    })
    .catch(err => {
      driveList.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€£æºçŠ¶æ…‹ã‚„ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      console.error(err);
    });
  };

  window.renameFile = () => {
    if (!selectedFileId) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    const newName = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
    if (!newName) return;
    fetch("https://www.googleapis.com/drive/v3/files/" + selectedFileId, {
      method: "PATCH",
      headers: {
        Authorization: "Bearer " + googleToken,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ name: newName })
    }).then(() => updateDisplay());
  };

  window.deleteFile = () => {
    if (!selectedFileId) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    fetch("https://www.googleapis.com/drive/v3/files/" + selectedFileId, {
      method: "DELETE",
      headers: {
        Authorization: "Bearer " + googleToken
      }
    }).then(() => updateDisplay());
  };

  window.createFolder = () => {
    const folderName = prompt("ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
    if (!folderName) return;
    fetch("https://www.googleapis.com/drive/v3/files", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + googleToken,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        name: folderName,
        mimeType: "application/vnd.google-apps.folder",
        parents: [currentFolder]
      })
    }).then(() => updateDisplay());
  };

  window.moveFile = () => {
    if (!selectedFileId) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    const newParentId = prompt("ç§»å‹•å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
    if (!newParentId) return;
    fetch("https://www.googleapis.com/drive/v3/files/" + selectedFileId + "?addParents=" + newParentId + "&removeParents=" + currentFolder, {
      method: "PATCH",
      headers: {
        Authorization: "Bearer " + googleToken
      }
    }).then(() => updateDisplay());
  };

  if (googleToken) {
    fetch("https://www.googleapis.com/drive/v3/about?fields=rootFolderId", {
      headers: { Authorization: "Bearer " + googleToken }
    })
    .then(res => res.json())
    .then(data => {
      currentFolder = data.rootFolderId || 'root';
      updateDisplay();
    })
    .catch(err => {
      driveList.textContent = "ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      console.error(err);
    });
  }
})();
</script>
