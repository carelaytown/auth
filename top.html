<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CARELAY„Çø„Ç¶„É≥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Noto Sans JP', sans-serif;
      background: #f0f6ff;
    }
    #header {
      height: 50px;
      background-color: #1b355d;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
    }
    #header-left {
      display: flex;
      align-items: center;
    }
    #header-logo {
      font-weight: bold;
      margin-right: 15px;
    }
    #orgLabel {
      font-size: 14px;
    }
    #header-buttons button {
      margin-left: 8px;
      background: transparent;
      color: white;
      border: 1px solid white;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }
    #container {
      display: flex;
      height: calc(100% - 50px);
    }
    #menu {
      width: 220px;
      background-color: #ffe8b0;
      padding: 10px;
      overflow-y: auto;
    }
    .accordion-category {
      margin-bottom: 10px;
    }
    .accordion-button {
      width: 100%;
      background-color: #1b355d;
      color: white;
      border: none;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
    }
    .accordion-content {
      display: none;
      flex-direction: column;
      margin-top: 6px;
    }
    .accordion-content button {
      background-color: white;
      color: #1b355d;
      border: 1px solid #1b355d;
      padding: 6px;
      font-size: 13px;
      margin: 3px 0;
      border-radius: 4px;
      cursor: pointer;
    }
    #main {
      flex: 1;
      padding: 0;
      overflow: auto;
      background-color: white;
    }
    #footer {
      height: 30px;
      text-align: center;
      font-size: 12px;
      padding: 6px;
      background-color: #1b355d;
      color: white;
    }
  </style>
</head>
<body onload="initTopPage()">
  <div id="header">
    <div id="header-left">
      <div id="header-logo">üèôÔ∏è CARELAY„Çø„Ç¶„É≥</div>
      <div id="orgLabel">(Êú™ÁôªÈå≤)</div>
    </div>
    <div id="header-buttons">
      <button onclick="loadMain('mypage.html')">„Éû„Ç§„Éö„Éº„Ç∏</button>
      <button onclick="loadMain('howto.html')">‚ùì‰Ωø„ÅÑÊñπ</button>
    </div>
  </div>
  <div id="container">
    <div id="menu"></div>
    <div id="main"></div>
  </div>
  <div id="footer">¬© 2025 CARELAY TOWN</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = "https://viihcgkjzzhkdiwdzdex.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let userEmail = "";
    let userOrgName = "";
    let isAdmin = false;

    async function initTopPage() {
      const email = localStorage.getItem("carelayUser");
      const approved = localStorage.getItem("carelayApproved");
      if (!email || approved !== "ok") {
        location.href = "index.html";
        return;
      }

      userEmail = email.trim().toLowerCase();
      await fetchUserInfo(userEmail);

      document.getElementById("orgLabel").textContent = userOrgName;
      setupAccordionMenu();
      loadMain("map.html");
    }

    async function fetchUserInfo(email) {
      const { data, error } = await supabase
        .from("applications")
        .select("org_name, is_admin")
        .eq("email", email);

      if (data && data.length > 0) {
        userOrgName = data[0].org_name || "(Êú™ÁôªÈå≤)";
        isAdmin = data[0].is_admin || false;
        localStorage.setItem("carelayAdmin", isAdmin ? "true" : "false");
      } else {
        userOrgName = "(Êú™ÁôªÈå≤)";
        isAdmin = false;
      }
    }

    function setupAccordionMenu() {
      const categories = [
        { id: "tools", label: "„Éá„Éº„ÇøÁÆ°ÁêÜ" },
        { id: "work", label: "ÂÆüÂãô„ÉÑ„Éº„É´" },
        { id: "post", label: "‰æøÂà©„ÉÑ„Éº„É´" },
        { id: "message", label: "„É°„ÉÉ„Çª„Éº„Ç∏‰æø" },
        { id: "bank", label: "ÈáëÈä≠ÁÆ°ÁêÜ" },
        { id: "material", label: "Á¥†ÊùêÈõÜ" },
        { id: "info", label: "ÂïÜÊùêÁ¥π‰ªã" },
        { id: "office", label: "ÈÅãÂñ∂ÈÄ£Áµ°", admin_only: true }
      ];

      const menu = document.getElementById("menu");
      menu.innerHTML = "";

      for (const cat of categories) {
        if (cat.admin_only && !isAdmin) continue;

        const wrapper = document.createElement("div");
        wrapper.className = "accordion-category";

        const button = document.createElement("button");
        button.className = "accordion-button";
        button.textContent = cat.label;
        button.onclick = () => {
          const content = wrapper.querySelector(".accordion-content");
          content.style.display = content.style.display === "flex" ? "none" : "flex";
        };

        const content = document.createElement("div");
        content.className = "accordion-content";

        const listBtn = document.createElement("button");
        listBtn.textContent = "„Ç¢„Éó„É™‰∏ÄË¶ß";
        listBtn.onclick = () => loadMain(`${cat.id}-list.html`);
        content.appendChild(listBtn);

        wrapper.appendChild(button);
        wrapper.appendChild(content);
        menu.appendChild(wrapper);
      }
    }

    function loadMain(path) {
      fetch(path)
        .then(res => res.text())
        .then(html => {
          const main = document.getElementById("main");
          main.innerHTML = html;

          const scripts = main.querySelectorAll("script");
          scripts.forEach(oldScript => {
            const newScript = document.createElement("script");
            if (oldScript.src) {
              newScript.src = oldScript.src;
            } else {
              newScript.textContent = oldScript.textContent;
            }
            document.body.appendChild(newScript);
            oldScript.remove();
          });
        });
    }
  </script>
</body>
</html>
