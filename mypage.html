<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
(() => {
  const clientId = "589685294211-runfps2fdtqi9la02k4a4eh7lc1fndco.apps.googleusercontent.com";
  const carelayUser = localStorage.getItem("carelayUser") || "";
  const tokenKey = "carelayGoogleToken_" + carelayUser;
  const tokenTimeKey = "carelayGoogleTokenTime_" + carelayUser;
  let googleToken = localStorage.getItem(tokenKey) || "";
  let modalAction = "", modalTarget = "", modalState = "";

  function showModal(message, state = "") {
    modalState = state;
    document.getElementById("modalMessage").textContent = message;
    document.getElementById("mypage-modal").style.display = "flex";
  }

  function hideModal() {
    document.getElementById("mypage-modal").style.display = "none";
    modalState = "";
  }

  function updateGoogleStatus(email = null) {
    const statusEl = document.getElementById("googleStatus");
    const btnEl = document.getElementById("googleConnectBtn");
    if (email) {
      statusEl.textContent = "Google連携が完了しています（" + email + "）";
      btnEl.textContent = "🔓 連携解除";
    } else {
      statusEl.textContent = "Googleアカウントとまだ連携されていません。";
      btnEl.textContent = "🔗 Googleで連携";
    }
  }

  function isTokenExpired() {
    const saved = parseInt(localStorage.getItem(tokenTimeKey) || "0", 10);
    return !saved || (Date.now() - saved > 3600 * 1000);
  }

  function fetchGoogleAccountEmail() {
    if (!googleToken) {
      updateGoogleStatus(null);
      return;
    }
    fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
      headers: { Authorization: "Bearer " + googleToken }
    })
    .then(res => {
      if (!res.ok) throw new Error("Invalid token");
      return res.json();
    })
    .then(user => {
      if (user && user.email) {
        updateGoogleStatus(user.email);
      } else {
        updateGoogleStatus(null);
      }
    })
    .catch(() => {
      updateGoogleStatus(null);
    });
  }

  function autoRefreshGoogleToken() {
    if (!googleToken || !isTokenExpired()) {
      fetchGoogleAccountEmail();
      return;
    }
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/userinfo.email",
      prompt: "none",
      callback: res => {
        if (res && res.access_token) {
          googleToken = res.access_token;
          localStorage.setItem(tokenKey, googleToken);
          localStorage.setItem(tokenTimeKey, Date.now().toString());
          fetchGoogleAccountEmail();
        } else {
          updateGoogleStatus(null);
        }
      }
    });
    tokenClient.requestAccessToken();
  }

  function handleGoogleAuth() {
    if (googleToken) {
      localStorage.removeItem(tokenKey);
      localStorage.removeItem(tokenTimeKey);
      updateGoogleStatus(null);
      googleToken = "";
      return;
    }
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/userinfo.email",
      prompt: "consent",
      callback: res => {
        if (res && res.access_token) {
          googleToken = res.access_token;
          localStorage.setItem(tokenKey, googleToken);
          localStorage.setItem(tokenTimeKey, Date.now().toString());
          fetchGoogleAccountEmail();
        }
      }
    });
    tokenClient.requestAccessToken();
  }

  // 起動時処理
  document.addEventListener("DOMContentLoaded", () => {
    autoRefreshGoogleToken();
    const btn = document.getElementById("googleConnectBtn");
    if (btn) btn.onclick = handleGoogleAuth;
  });
})();
</script>
