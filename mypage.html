<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>マイページ - CARELAYタウン</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>CARELAYタウン マイページ</h1>
    </header>
    <main>
      <section>
        <h2>ログイン中のアカウント</h2>
        <p>事業所名：<span id="orgOutput"></span></p>
        <p>メールアドレス：<span id="emailOutput"></span></p>
      </section>
      <section>
        <h2>アカウント切替</h2>
        <input type="email" id="emailInput" placeholder="メールアドレスを入力" />
        <button id="switchBtn">追加して切り替え</button>
        <ul id="accountList"></ul>
      </section>
      <section>
        <h2>Google連携</h2>
        <div id="googleInfo"></div>
        <button id="connectBtn">Googleと連携</button>
        <button id="disconnectBtn">連携解除</button>
      </section>
      <section>
        <h2>ログアウト</h2>
        <button id="logoutBtn">ログアウト</button>
      </section>
    </main>
    <footer>
      <p>&copy; CARELAYタウン</p>
    </footer>

    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <p id="modalMessage"></p>
        <button id="modalOk">OK</button>
        <button id="modalCancel">キャンセル</button>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://viihcgkjzzhkdiwdzdex.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd3pkZXgiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcwNzk1ODI2NSwiZXhwIjoyMDIzNTM0MjY1fQ.QHTKzSfzMZINuGJBSJKz_QO9itEsZZ8rdJJThrdI6zU"
      );

      const emailInput = document.getElementById("emailInput");
      const switchBtn = document.getElementById("switchBtn");
      const orgOutput = document.getElementById("orgOutput");
      const emailOutput = document.getElementById("emailOutput");
      const accountList = document.getElementById("accountList");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const googleInfo = document.getElementById("googleInfo");
      const logoutBtn = document.getElementById("logoutBtn");

      const modal = document.getElementById("modal");
      const modalMessage = document.getElementById("modalMessage");
      const modalOk = document.getElementById("modalOk");
      const modalCancel = document.getElementById("modalCancel");

      let modalAction = "";

      function showModal(message, action) {
        modalMessage.textContent = message;
        modalAction = action;
        modal.classList.remove("hidden");
      }

      function hideModal() {
        modal.classList.add("hidden");
      }

      modalOk.addEventListener("click", () => {
        if (modalAction === "add") handleAccountSwitch();
        else if (modalAction === "delete") handleAccountDelete();
        else if (modalAction === "logout") handleLogout();
        hideModal();
      });

      modalCancel.addEventListener("click", hideModal);

      switchBtn.addEventListener("click", () => showModal("このメールアドレスを追加して切り替えますか？", "add"));

      async function loadAccount() {
        const currentEmail = localStorage.getItem("carelayCurrentAccount");
        if (!currentEmail) return;
        emailOutput.textContent = currentEmail;

        const { data, error } = await supabase
          .from("applications")
          .select("org_name")
          .eq("email", currentEmail)
          .eq("status", "approved")
          .single();
        orgOutput.textContent = error ? "未登録" : data.org_name;
      }

      async function handleAccountSwitch() {
        const email = emailInput.value.trim();
        if (!email) return;
        const stored = JSON.parse(localStorage.getItem("carelayAccounts") || "[]");
        if (!stored.includes(email)) stored.push(email);
        localStorage.setItem("carelayAccounts", JSON.stringify(stored));
        localStorage.setItem("carelayCurrentAccount", email);
        location.reload();
      }

      function showAccounts() {
        const stored = JSON.parse(localStorage.getItem("carelayAccounts") || "[]");
        accountList.innerHTML = "";
        stored.forEach(email => {
          const li = document.createElement("li");
          li.textContent = email;
          li.addEventListener("click", () => {
            localStorage.setItem("carelayCurrentAccount", email);
            location.reload();
          });
          const delBtn = document.createElement("button");
          delBtn.textContent = "🗑️";
          delBtn.addEventListener("click", () => {
            showModal(`${email} を削除しますか？`, "delete");
            modalOk.onclick = () => {
              const filtered = stored.filter(e => e !== email);
              localStorage.setItem("carelayAccounts", JSON.stringify(filtered));
              if (localStorage.getItem("carelayCurrentAccount") === email) {
                localStorage.removeItem("carelayCurrentAccount");
              }
              location.reload();
            };
          });
          li.appendChild(delBtn);
          accountList.appendChild(li);
        });
      }

      connectBtn.addEventListener("click", handleGoogleAuth);
      disconnectBtn.addEventListener("click", () => {
        localStorage.removeItem("carelayGoogleToken");
        googleInfo.textContent = "連携されていません";
      });

      async function handleGoogleAuth(promptMode = "") {
        const client_id = "51477026010-7da9v0fe1ls9g1nrf6l90erf9npdi6ei.apps.googleusercontent.com";
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id,
          scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/userinfo.email",
          prompt: promptMode,
          callback: async (tokenResponse) => {
            if (tokenResponse.error) {
              googleInfo.textContent = "連携に失敗しました";
              return;
            }
            localStorage.setItem("carelayGoogleToken", tokenResponse.access_token);
            const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
              headers: { Authorization: `Bearer ${tokenResponse.access_token}` },
            });
            const profile = await res.json();
            googleInfo.textContent = `連携中：${profile.email}`;
          },
        });
        tokenClient.requestAccessToken({ prompt: promptMode });
      }

      async function attemptSilentAuth() {
        const token = localStorage.getItem("carelayGoogleToken");
        if (!token) {
          // セッション切れや未連携時に自動再連携（silent）を試行
          handleGoogleAuth("");
        } else {
          // 表示だけ更新
          const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (res.ok) {
            const profile = await res.json();
            googleInfo.textContent = `連携中：${profile.email}`;
          } else {
            handleGoogleAuth("");
          }
        }
      }

      logoutBtn.addEventListener("click", () => showModal("ログアウトしますか？", "logout"));

      function handleLogout() {
        localStorage.clear();
        location.href = "index.html";
      }

      loadAccount();
      showAccounts();
      attemptSilentAuth();
    </script>
  </body>
</html>
