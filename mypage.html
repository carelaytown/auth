<!-- 修正済 mypage.html（Google連携機能のみ修正） -->
<script>
window.modalState = "";

function showModal(message, state = "") {
  window.modalState = state;
  const modal = document.getElementById("mypage-modal");
  const modalMessage = document.getElementById("modalMessage");
  if (modal && modalMessage) {
    modalMessage.textContent = message;
    modal.style.display = "flex";
  }
}

async function checkTokenValidity(token) {
  const userKey = localStorage.getItem("carelayUser");
  const tokenKey = userKey ? "carelayGoogleToken_" + userKey : null;
  const savedToken = tokenKey ? localStorage.getItem(tokenKey) : null;
  const wasLinked = !!(userKey && savedToken);
  if (!token) return true;

  const res = await fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
    headers: { Authorization: "Bearer " + token }
  });
  if (res.status === 401 && wasLinked) {
    showModal("Google連携が切れています。再連携してください", "reconnect");
    return false;
  }
  return true;
}

async function createCarelayFolder(token) {
  const existing = localStorage.getItem("carelayDriveFolderId");
  if (existing) return;
  const res = await fetch("https://www.googleapis.com/drive/v3/files?q=name='CARELAYTOWN'+and+mimeType='application/vnd.google-apps.folder'+and+trashed=false", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();
  if (data.files?.[0]?.id) {
    localStorage.setItem("carelayDriveFolderId", data.files[0].id);
    return;
  }
  const createRes = await fetch("https://www.googleapis.com/drive/v3/files", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      name: "CARELAYTOWN",
      mimeType: "application/vnd.google-apps.folder"
    })
  });
  const newData = await createRes.json();
  if (newData.id) {
    localStorage.setItem("carelayDriveFolderId", newData.id);
  }
}
</script>
