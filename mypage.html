
<div id="mypage-app">
  <div class="mypage-container">
    <div class="box highlight">
      <strong>ログイン中のアカウント</strong><br>
      <div class="org" id="orgOutput">(取得中…)</div>
      <div class="email" id="emailOutput">-</div>
    </div>

    <div class="box input-area">
      <strong>アカウント切替・追加</strong>
      <input type="email" id="newAccount" placeholder="メールアドレスを入力" />
      <button id="addAccountBtn">追加して切り替え</button>
      <div class="account-list" id="accountList"></div>
    </div>

    <div class="box google-connect" id="googleBox">
      <strong>Google連携</strong><br>
      <div id="googleStatus">Googleアカウントとまだ連携されていません。</div>
      <button id="googleConnectBtn">🔗 Googleで連携</button>
    </div>

    <div class="box warning">
      <button id="logoutBtn" style="background-color:#d9534f;">⛔ ログアウト</button>
    </div>
  </div>
</div>

<div id="mypage-modal" class="modal-bg" style="display:none;">
  <div class="modal-box">
    <p id="modalMessage">メッセージ</p>
    <button id="modalOk">OK</button>
    <button id="modalCancel">キャンセル</button>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
(() => {
  const clientId = "589685294211-runfps2fdtqi9la02k4a4eh7lc1fndco.apps.googleusercontent.com";
  let modalAction = "", modalTarget = "";

  const carelayUser = localStorage.getItem("carelayUser") || "";
  const tokenKey = "carelayGoogleToken_" + carelayUser;
  let googleToken = localStorage.getItem(tokenKey) || "";

  const googleStatus = document.getElementById("googleStatus");
  const googleBtn = document.getElementById("googleConnectBtn");

  async function fetchGoogleAccountEmail() {
    if (!googleToken) return;
    try {
      const res = await fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
        headers: { Authorization: "Bearer " + googleToken }
      });
      const user = await res.json();
      if (user && user.email) {
        googleStatus.textContent = "Google連携が完了しています（" + user.email + "）";
      }
    } catch (e) {
      console.error("メール取得失敗", e);
    }
  }

  async function createDriveFolder(token) {
    if (localStorage.getItem("carelaytownFolderId")) return;
    try {
      const res = await fetch("https://www.googleapis.com/drive/v3/files", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          name: "carelaytown",
          mimeType: "application/vnd.google-apps.folder"
        })
      });
      const data = await res.json();
      if (data.id) {
        localStorage.setItem("carelaytownFolderId", data.id);
        console.log("フォルダ作成成功:", data.id);
      }
    } catch (e) {
      console.error("フォルダ作成エラー", e);
    }
  }

  function handleGoogleAuth() {
    if (googleToken) {
      localStorage.removeItem(tokenKey);
      localStorage.removeItem("carelaytownFolderId");
      googleToken = "";
      googleStatus.textContent = "Googleアカウントとまだ連携されていません。";
      googleBtn.textContent = "🔗 Googleで連携";
      return;
    }
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/userinfo.email",
      prompt: "consent",
      callback: async (res) => {
        if (res && res.access_token) {
          googleToken = res.access_token;
          localStorage.setItem(tokenKey, googleToken);
          await fetchGoogleAccountEmail();
          await createDriveFolder(googleToken);
          googleBtn.textContent = "🔓 連携解除";
        }
      }
    });
    tokenClient.requestAccessToken();
  }

  googleBtn.onclick = handleGoogleAuth;

  if (googleToken) {
    fetchGoogleAccountEmail();
    createDriveFolder(googleToken);
    googleBtn.textContent = "🔓 連携解除";
  }
})();
</script>
