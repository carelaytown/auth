<!-- CARELAYã‚¿ã‚¦ãƒ³ ãƒã‚¤ãƒšãƒ¼ã‚¸ v1 -->
<div id="mypage-app">
  <div class="mypage-container">
    <!-- â‘  ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º -->
    <div class="box highlight">
      <strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong><br>
      <div class="org" id="orgOutput">(å–å¾—ä¸­â€¦)</div>
      <div class="email" id="emailOutput">-</div>
    </div>

    <!-- â‘¡ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ ãƒ»åˆ‡æ›¿ -->
    <div class="box input-area">
      <strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿ãƒ»è¿½åŠ </strong>
      <input type="email" id="newAccount" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›" />
      <button id="addAccountBtn">è¿½åŠ ã—ã¦åˆ‡ã‚Šæ›¿ãˆ</button>
      <div class="account-list" id="accountList"></div>
    </div>

    <!-- â‘¢ Googleé€£æº -->
    <div class="box google-connect" id="googleBox">
      <strong>Googleé€£æº</strong><br>
      <div id="googleStatus">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã¾ã é€£æºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
        <button id="googleConnectBtn">ğŸ”— Googleã§é€£æº</button>
        <button id="createDriveFolderBtn">ğŸ“ CARELAYTOWNãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</button>
      </div>
    </div>

    <!-- â‘£ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
    <div class="box warning">
      <button id="logoutBtn" style="background-color:#d9534f;">â›” ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="mypage-modal" class="modal-bg" style="display:none;">
  <div class="modal-box">
    <p id="modalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
    <button id="modalOk">OK</button>
    <button id="modalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<style>
  #mypage-app .mypage-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }
  #mypage-app .box {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #mypage-app .highlight { background-color: #e6f0ff; }
  #mypage-app .input-area { background-color: #f4f4f4; }
  #mypage-app .google-connect { background-color: #e8f5e9; border-left: 5px solid #66bb6a; }
  #mypage-app .warning { background-color: #fff8e1; }
  #mypage-app .account-list button {
    display: inline-flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    background: #eef4ff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px 10px;
    margin-top: 8px;
    cursor: pointer;
  }
  #mypage-app input[type="email"] {
    width: 100%;
    padding: 8px;
    font-size: 14px;
    margin-bottom: 10px;
  }
  #mypage-app button {
    padding: 8px 16px;
    background-color: #2a6ebb;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #mypage-app button:hover { background-color: #1e5393; }
  #mypage-app .email { font-size: 14px; color: #555; }
  #mypage-app .org { font-weight: bold; }

  .modal-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
  }

  .modal-box {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    width: 320px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    position: relative;
  }

  .modal-box::before {
    content: "âš ï¸";
    font-size: 32px;
    display: block;
    margin-bottom: 10px;
  }

  .modal-box p {
    margin-bottom: 20px;
    font-size: 16px;
    color: #333;
  }

  .modal-box button {
    display: inline-block;
    width: 100px;
    padding: 8px;
    margin: 8px 5px 0;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    border: none;
  }

  #modalOk {
    background-color: #2a6ebb;
    color: white;
  }

  #modalCancel {
    background-color: #eee;
    color: #333;
  }

  #modalCancel:hover {
    background-color: #ddd;
  }

  #modalOk:hover {
    background-color: #1e5393;
  }

  #mypage-app .account-list button span {
    color: #333 !important;
  }
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
(() => {
  const clientId = "589685294211-runfps2fdtqi9la02k4a4eh7lc1fndco.apps.googleusercontent.com";
  let googleToken = "";
  let modalAction = "", modalTarget = "", modalState = "";

  function showModal(message, state = "") {
    modalState = state;
    document.getElementById("modalMessage").textContent = message;
    document.getElementById("mypage-modal").style.display = "flex";
  }

  function hideModal() {
    document.getElementById("mypage-modal").style.display = "none";
    modalAction = modalTarget = modalState = "";
  }

// --- Googleé€£æºã®çŠ¶æ…‹ã‚’ç®¡ç† ---
function updateGoogleUI(status, email = "") {
  const statusText = document.getElementById("googleStatus");
  const connectBtn = document.getElementById("googleConnectBtn");
  const folderBtn = document.getElementById("createDriveFolderBtn");

  if (status === "unlinked") {
    statusText.textContent = "Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã¾ã é€£æºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
    connectBtn.textContent = "ğŸ”— Googleã§é€£æº";
    folderBtn.disabled = true;
  } else if (status === "linked") {
    statusText.textContent = `Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é€£æºæ¸ˆï¼ˆ${email}ï¼‰`;
    connectBtn.textContent = "ğŸ”“ é€£æºè§£é™¤";
    folderBtn.disabled = false;
  } else if (status === "expired") {
    statusText.textContent = "Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã®é€£æºãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚";
    connectBtn.textContent = "ğŸ” Googleã«å†é€£æº";
    folderBtn.disabled = true;
  }
}

// --- ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ç¢ºèªã¨å†é€£æºå‡¦ç† ---
async function checkTokenValidity(token, onSuccess, onExpired) {
  const res = await fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
    headers: { Authorization: "Bearer " + token }
  });
  if (res.status === 401) {
    updateGoogleUI("expired");
    handleGoogleAuth(true); // å†é€£æºã‚’è©¦è¡Œ
    return false;
  } else {
    const user = await res.json();
    if (user?.email) onSuccess(user.email);
    return true;
  }
}

// --- Googleé€£æºå‡¦ç†ï¼ˆåˆå›ãƒ»å†é€£æºå…±é€šï¼‰ ---
function handleGoogleAuth(isRetry = false) {
  const user = localStorage.getItem("carelayUser") || "";
  const tokenKey = "carelayGoogleToken_" + user;

  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: "589685294211-runfps2fdtqi9la02k4a4eh7lc1fndco.apps.googleusercontent.com",
    scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email",
    prompt: isRetry ? "" : "consent",
    callback: res => {
      if (res?.access_token) {
        localStorage.setItem(tokenKey, res.access_token);
        fetchGoogleAccountEmail(res.access_token);
      } else if (isRetry) {
        showModal("è‡ªå‹•å†é€£æºã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å†æ¥ç¶šã—ã¦ãã ã•ã„ã€‚");
      }
    }
  });
  tokenClient.requestAccessToken();
}

// --- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã¨UIæ›´æ–° ---
function fetchGoogleAccountEmail(token) {
  fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
    headers: { Authorization: "Bearer " + token }
  })
  .then(res => res.json())
  .then(user => {
    if (user?.email) {
      updateGoogleUI("linked", user.email);
    }
  });
}

// --- Driveãƒ•ã‚©ãƒ«ãƒ€ä½œæˆï¼ˆå¸¸ã«APIç¢ºèªï¼‰ ---
async function createCarelayFolder(token) {
  const q = encodeURIComponent("name='CARELAYTOWN' and mimeType='application/vnd.google-apps.folder' and trashed=false");
  const res = await fetch("https://www.googleapis.com/drive/v3/files?q=" + q, {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();
  if (data?.files?.[0]?.id) {
    showModal("CARELAYTOWN ãƒ•ã‚©ãƒ«ãƒ€ã¯æ—¢ã«ä½œæˆæ¸ˆã§ã™ã€‚");
    return;
  }
  const createRes = await fetch("https://www.googleapis.com/drive/v3/files", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ name: "CARELAYTOWN", mimeType: "application/vnd.google-apps.folder" })
  });
  const newData = await createRes.json();
  if (newData?.id) {
    showModal("CARELAYTOWN ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚");
  }
}

  function initMypage() {
    const supabase = window.supabaseClient;
    const orgOutput = document.getElementById("orgOutput");
    const emailOutput = document.getElementById("emailOutput");
    const accountList = document.getElementById("accountList");
    const connectBtn = document.getElementById("googleConnectBtn");
    const folderBtn = document.getElementById("createDriveFolderBtn");

    const user = localStorage.getItem("carelayUser") || "-";
    const tokenKey = "carelayGoogleToken_" + user;
    googleToken = localStorage.getItem(tokenKey) || "";

    function fetchCurrentOrg() {
      emailOutput.textContent = user;
      orgOutput.textContent = user === "-" ? "(æœªãƒ­ã‚°ã‚¤ãƒ³)" : localStorage.getItem("carelayOrgName") || "(æœªå–å¾—)";
    }

    function renderAccountList() {
      const list = JSON.parse(localStorage.getItem("carelayList") || "[]");
      accountList.innerHTML = "";
      list.forEach(email => {
        if (email === user) return;
        const btn = document.createElement("button");
        btn.innerHTML = `<span>${email}</span><i>ğŸ—‘ï¸</i>`;
        btn.onclick = () => {
          localStorage.setItem("carelayUser", email);
          localStorage.setItem("carelayApproved", "ok");
          location.reload();
        };
        btn.querySelector("i").onclick = e => {
          e.stopPropagation();
          modalAction = "delete"; modalTarget = email;
          showModal(`${email} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
        };
        accountList.appendChild(btn);
      });
    }

    async function modalOk() {
      hideModal();
      if (modalState === "reconnect") return handleGoogleAuth(true);

      if (modalAction === "add") {
        const input = modalTarget;
        const { data, error } = await supabase.from("applications").select("org_name, status").eq("email", input);
        if (!error && data.length > 0 && data[0].status === "approved") {
          localStorage.setItem("carelayUser", input);
          localStorage.setItem("carelayApproved", "ok");
          localStorage.setItem("carelayOrgName", data[0].org_name || "(ä¸æ˜)");
          let list = JSON.parse(localStorage.getItem("carelayList") || "[]");
          if (!list.includes(input)) {
            list.push(input);
            localStorage.setItem("carelayList", JSON.stringify(list));
          }
          location.reload();
        } else {
          showModal("æ‰¿èªã•ã‚Œã¦ã„ãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚");
        }
      } else if (modalAction === "delete") {
        let list = JSON.parse(localStorage.getItem("carelayList") || "[]");
        list = list.filter(e => e !== modalTarget);
        localStorage.setItem("carelayList", JSON.stringify(list));
        renderAccountList();
      } else if (modalAction === "logout") {
        localStorage.clear();
        location.href = "index.html";
      }
    }

    function confirmAdd() {
      const input = document.getElementById("newAccount").value.trim().toLowerCase();
      if (!input) return showModal("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      modalAction = "add"; modalTarget = input;
      showModal(`${input} ã‚’è¿½åŠ ã—ã¦åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ`);
    }

    function confirmLogout() {
      modalAction = "logout";
      showModal("æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ");
    }

    fetchCurrentOrg();
    renderAccountList();

    if (googleToken) {
      checkTokenValidity(googleToken, email => {
        updateGoogleUI("linked", email);
        fetchGoogleAccountEmail(googleToken);
      });
    } else {
      updateGoogleUI("unlinked");
    }

    document.getElementById("addAccountBtn").onclick = confirmAdd;
    document.getElementById("logoutBtn").onclick = confirmLogout;
    document.getElementById("modalOk").onclick = modalOk;
    document.getElementById("modalCancel").onclick = hideModal;
    connectBtn.onclick = () => {
      if (googleToken) {
        localStorage.removeItem(tokenKey);
        googleToken = "";
        updateGoogleUI("unlinked");
      } else {
        handleGoogleAuth(false);
      }
    };
    folderBtn.onclick = () => createCarelayFolder(googleToken);
  }

  if (window.waitForSupabaseReady) {
    window.waitForSupabaseReady(initMypage);
  } else {
    window.addEventListener("DOMContentLoaded", initMypage);
  }

})();
</script>
