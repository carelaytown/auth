
<div id="mypage-app">
  <div class="mypage-container">
    <div class="box highlight">
      <strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong><br>
      <div class="org" id="orgOutput">(å–å¾—ä¸­â€¦)</div>
      <div class="email" id="emailOutput">-</div>
    </div>

    <div class="box input-area">
      <strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿ãƒ»è¿½åŠ </strong>
      <input type="email" id="newAccount" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›" />
      <button id="addAccountBtn">è¿½åŠ ã—ã¦åˆ‡ã‚Šæ›¿ãˆ</button>
      <div class="account-list" id="accountList"></div>
    </div>

    <div class="box google-connect" id="googleBox">
      <strong>Googleé€£æº</strong><br>
      <div id="googleStatus">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã¾ã é€£æºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
      <button id="googleConnectBtn">ğŸ”— Googleã§é€£æº</button>
    </div>

    <div class="box warning">
      <button id="logoutBtn" style="background-color:#d9534f;">â›” ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>
</div>

<div id="mypage-modal" class="modal-bg" style="display:none;">
  <div class="modal-box">
    <p id="modalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
    <button id="modalOk">OK</button>
    <button id="modalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
(() => {
  const clientId = "589685294211-runfps2fdtqi9la02k4a4eh7lc1fndco.apps.googleusercontent.com";
  let modalAction = "", modalTarget = "";

  const carelayUser = localStorage.getItem("carelayUser") || "";
  const tokenKey = "carelayGoogleToken_" + carelayUser;
  let googleToken = localStorage.getItem(tokenKey) || "";

  const googleStatus = document.getElementById("googleStatus");
  const googleBtn = document.getElementById("googleConnectBtn");

  async function fetchGoogleAccountEmail() {
    if (!googleToken) return;
    try {
      const res = await fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json", {
        headers: { Authorization: "Bearer " + googleToken }
      });
      const user = await res.json();
      if (user && user.email) {
        googleStatus.textContent = "Googleé€£æºãŒå®Œäº†ã—ã¦ã„ã¾ã™ï¼ˆ" + user.email + "ï¼‰";
      }
    } catch (e) {
      console.error("ãƒ¡ãƒ¼ãƒ«å–å¾—å¤±æ•—", e);
    }
  }

  async function createDriveFolder(token) {
    if (localStorage.getItem("carelaytownFolderId")) return;
    try {
      const res = await fetch("https://www.googleapis.com/drive/v3/files", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          name: "carelaytown",
          mimeType: "application/vnd.google-apps.folder"
        })
      });
      const data = await res.json();
      if (data.id) {
        localStorage.setItem("carelaytownFolderId", data.id);
        console.log("ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆæˆåŠŸ:", data.id);
      }
    } catch (e) {
      console.error("ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã‚¨ãƒ©ãƒ¼", e);
    }
  }

  function handleGoogleAuth() {
    if (googleToken) {
      localStorage.removeItem(tokenKey);
      localStorage.removeItem("carelaytownFolderId");
      googleToken = "";
      googleStatus.textContent = "Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã¾ã é€£æºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
      googleBtn.textContent = "ğŸ”— Googleã§é€£æº";
      return;
    }
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/userinfo.email",
      prompt: "consent",
      callback: async (res) => {
        if (res && res.access_token) {
          googleToken = res.access_token;
          localStorage.setItem(tokenKey, googleToken);
          await fetchGoogleAccountEmail();
          await createDriveFolder(googleToken);
          googleBtn.textContent = "ğŸ”“ é€£æºè§£é™¤";
        }
      }
    });
    tokenClient.requestAccessToken();
  }

  googleBtn.onclick = handleGoogleAuth;

  if (googleToken) {
    fetchGoogleAccountEmail();
    createDriveFolder(googleToken);
    googleBtn.textContent = "ğŸ”“ é€£æºè§£é™¤";
  }
})();
</script>
