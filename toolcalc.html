<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CARELAYタウン電卓（修正版）</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 16px;
      color: #333;
      line-height: 1.4;
      margin: 0;
      padding: 0;
    }
    label, input, textarea, button {
      font-family: inherit;
      font-size: inherit;
    }
    textarea { resize: none; }
    #toolcalc-app {
      display: flex;
      gap: 40px;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }
    .left-col {
      flex: 1;
      min-width: 360px;
      max-width: 460px;
    }
    .right-col {
      flex: 1;
      min-width: 400px;
      max-width: 600px;
    }
    .panel {
      background: #f9f9f9;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .display-area {
      margin-bottom: 12px;
    }
    .display-area .formula, .display-area .result {
      width: 100%;
      padding: 10px;
      margin-bottom: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: white;
      text-align: right;
    }
    .formula { font-size: 18px; color: #555; }
    .result { font-size: 24px; font-weight: bold; }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .button-grid button {
      padding: 16px;
      font-size: 18px;
      border: none;
      border-radius: 6px;
      background-color: #eeeeee;
      cursor: pointer;
    }
    .button-grid button.op { background-color: #d1e7fd; }
    .button-grid button.eq { background-color: #fcd34d; }
    .button-grid button.ac { background-color: #fca5a5; }
    .button-grid button.tax { background-color: #c7d2fe; }
    .history-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 0;
      border-bottom: 1px solid #ddd;
    }
    .history-item .exp {
      flex: 1;
      white-space: nowrap;
    }
    .history-item textarea {
      flex-shrink: 0;
      width: 160px;
      height: 24px;
    }
    .history-item button {
      font-size: 12px;
      padding: 4px 6px;
    }
  </style>
</head>
<body>
<div id="toolcalc-app">
  <div class="left-col">
    <div class="display-area">
      <div class="formula" id="formula">式</div>
      <div class="result" id="result">0</div>
    </div>
    <div class="button-grid">
      <button class="ac" onclick="clearCalc()">AC</button>
      <button onclick="appendCalc('(')">(</button>
      <button onclick="appendCalc(')')">)</button>
      <button class="op" onclick="appendCalc('/')">÷</button>
      <button onclick="appendCalc('7')">7</button>
      <button onclick="appendCalc('8')">8</button>
      <button onclick="appendCalc('9')">9</button>
      <button class="op" onclick="appendCalc('*')">×</button>
      <button onclick="appendCalc('4')">4</button>
      <button onclick="appendCalc('5')">5</button>
      <button onclick="appendCalc('6')">6</button>
      <button class="op" onclick="appendCalc('-')">−</button>
      <button onclick="appendCalc('1')">1</button>
      <button onclick="appendCalc('2')">2</button>
      <button onclick="appendCalc('3')">3</button>
      <button class="op" onclick="appendCalc('+')">＋</button>
      <button onclick="appendCalc('0')">0</button>
      <button onclick="appendCalc('.')">.</button>
      <button class="eq" onclick="computeCalc()">=</button>
      <button class="eq" onclick="saveHistory()">保存</button>
      <button class="tax" onclick="applyTax(1.10)">税10%</button>
      <button class="tax" onclick="applyTax(1.08)">税8%</button>
      <button class="tax" onclick="removeTax()">非課税</button>
      <button onclick="restorePrevious()">戻る</button>
    </div>
  </div>
  <div class="right-col">
    <div class="panel">
      <h3>計算履歴 (5件まで)</h3>
      <div id="history-list"></div>
    </div>
    <div class="panel">
      <h3>デザイン設定</h3>
      <div><label>電卓色: <input type="color" id="calcBgColor" value="#f5f5f5"></label></div>
      <div><label>背景色: <input type="color" id="screenBgColor" value="#ffffff"></label></div>
      <div><label>背景画像: <input type="file" id="bgFile"></label>  <button onclick="removeBgImage()">背景画像を削除</button></div>
      <div><button onclick="resetDesign()">デザインリセット</button></div>
      <label>ボタン色: <input type="color" id="btnColor" value="#eeeeee"></label>
      <label>電卓背景色: <input type="color" id="calcBgColor" value="#f5f5f5"></label>
      <label>画面背景色: <input type="color" id="screenBgColor" value="#ffffff"></label>
      <label>背景画像: <input type="file" id="bgFile"></label>
      <button onclick="removeBgImage()">背景画像を削除</button>
      <button onclick="resetDesign()">デザインリセット</button>
    </div>
    <div class="panel">
      <h3>キーボード操作ガイド</h3>
      <ul>
        <li>数字、+ - * / . () で入力</li>
        <li>Enterで計算、Backspaceで削除</li>
        <li>c: クリア、s: 保存</li>
      </ul>
    </div>
  </div>
</div>
<script>
(() => {
  let calcFormula = "";
  let calcResult = "";
  let prevFormula = "";
  let prevResult = "";
  const formulaEl = document.getElementById("formula");
  const resultEl = document.getElementById("result");
  const historyListEl = document.getElementById("history-list");
  let historyData = JSON.parse(localStorage.getItem("calc_history") || "[]");

  function updateDisplay() {
    formulaEl.textContent = calcFormula || "式";
    resultEl.textContent = calcResult || "0";
  }

  window.appendCalc = val => { calcFormula += val; updateDisplay(); };
  window.clearCalc = () => { calcFormula = ""; calcResult = ""; updateDisplay(); };
  window.restorePrevious = () => {
    calcFormula = prevFormula; calcResult = prevResult;
    updateDisplay();
  };
  window.computeCalc = () => {
    try {
      prevFormula = calcFormula;
      prevResult = calcResult;
      calcResult = eval(calcFormula);
    } catch {
      calcResult = "Error";
    }
    updateDisplay();
  };
  window.applyTax = rate => {
    if (calcResult !== "" && !isNaN(calcResult)) {
      calcResult = Math.round(calcResult * rate * 100) / 100;
      updateDisplay();
    } else {
      calcFormula += "*" + rate;
      updateDisplay();
    }
  };
  window.removeTax = () => {
    calcFormula = calcFormula.replace(/\*1\.(10|08)/, "");
    computeCalc();
  };
  window.saveHistory = () => {
    if (!calcFormula) return;
    const entry = { formula: calcFormula, result: calcResult, memo: "" };
    historyData.unshift(entry); historyData = historyData.slice(0, 5);
    localStorage.setItem("calc_history", JSON.stringify(historyData));
    renderHistory();
  };
  function renderHistory() {
    historyListEl.innerHTML = "";
    for (let i = 0; i < 5; i++) {
      const item = historyData[i];
      const div = document.createElement("div");
      div.className = "history-item";
      if (item) {
        div.innerHTML = `
          <div class="exp"><strong>${item.formula} = ${item.result}</strong></div>
          <textarea>${item.memo || ""}</textarea>
          <button onclick="appendFromHistory(${i})">読込</button>
          <button onclick="deleteHistory(${i})">削除</button>
        `;
        div.querySelector("textarea").addEventListener("change", function() {
          item.memo = this.value;
          localStorage.setItem("calc_history", JSON.stringify(historyData));
        });
      } else {
        div.innerHTML = `<div class="exp">空欄</div><textarea></textarea>`;
      }
      historyListEl.appendChild(div);
    }
  }

  window.appendFromHistory = i => {
    if (historyData[i]) {
      calcFormula += historyData[i].result.toString();
      updateDisplay();
    }
  };
  window.deleteHistory = i => {
    historyData.splice(i, 1);
    localStorage.setItem("calc_history", JSON.stringify(historyData));
    renderHistory();
  };
  });
  });
  document.getElementById("calcBgColor").addEventListener("change", function() {
    document.querySelector(".left-col").style.backgroundColor = this.value;
  });
  document.getElementById("screenBgColor").addEventListener("change", function() {
    const main = document.getElementById("main");
    if (main) main.style.backgroundColor = this.value;
  });
  document.getElementById("bgFile").addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        const main = document.getElementById("main");
        if (main) {
          main.style.backgroundImage = "url('" + e.target.result + "')";
          main.style.backgroundSize = "cover";
        }
      };
      reader.readAsDataURL(file);
    }
  });
  window.removeBgImage = () => {
    const main = document.getElementById("main");
    if (main) main.style.backgroundImage = "";
  };
  window.resetDesign = () => {
    };
  document.addEventListener("keydown", e => {
    const key = e.key;
    if ("0123456789.+-*/()".includes(key)) appendCalc(key);
    else if (key === "Enter") computeCalc();
    else if (key === "Backspace") {
      calcFormula = calcFormula.slice(0, -1); updateDisplay();
    } else if (key === "c") clearCalc();
    else if (key === "s") saveHistory();
  });

  updateDisplay();
  renderHistory();
})();
</script>
</body>
</html>
