
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CARELAYタウン電卓</title>
</head>
<body>
<div id="toolcalc-app" style="display:flex; gap:20px; justify-content:center; align-items:flex-start;">
  <!-- 左パネル -->
  <div id="left-panel" style="flex-shrink:0; width:240px;">
    <style>
      .display-area { margin-bottom: 12px; }
      .display-area .formula, .display-area .result {
        width: 100%; padding: 10px; margin-bottom: 4px;
        border: 1px solid #ccc; border-radius: 6px;
        background: white; text-align: right;
      }
      .display-area .formula { font-size: 18px; color: #555; }
      .display-area .result { font-size: 24px; font-weight: bold; }
      .button-grid {
        display: grid; grid-template-columns: repeat(4, 1fr);
        gap: 10px; margin-bottom: 16px;
      }
      .button-grid button {
        padding: 16px; font-size: 18px;
        border: none; border-radius: 6px;
        background-color: #eeeeee; cursor: pointer;
        transition: transform 0.1s, background 0.1s;
      }
      .button-grid button:active { transform: scale(0.95); }
      .button-grid button.op { background-color: #d1e7fd; }
      .button-grid button.op:active { background-color: #aad4fa; }
      .button-grid button.eq { background-color: #fcd34d; }
      .button-grid button.eq:active { background-color: #fbbf24; }
      .button-grid button.ac { background-color: #fca5a5; }
      .button-grid button.ac:active { background-color: #f87171; }
      .button-grid button.tax { background-color: #c7d2fe; }
      .button-grid button.tax:active { background-color: #a5b4fc; }
    </style>
    <div class="display-area">
      <div class="formula" id="formula">式</div>
      <div class="result" id="result">0</div>
    </div>
    <div class="button-grid">
      <button class="ac" onclick="clearCalc()">AC</button>
      <button onclick="appendCalc('(')">(</button>
      <button onclick="appendCalc(')')">)</button>
      <button class="op" onclick="appendCalc('/')">÷</button>
      <button onclick="appendCalc('7')">7</button>
      <button onclick="appendCalc('8')">8</button>
      <button onclick="appendCalc('9')">9</button>
      <button class="op" onclick="appendCalc('*')">×</button>
      <button onclick="appendCalc('4')">4</button>
      <button onclick="appendCalc('5')">5</button>
      <button onclick="appendCalc('6')">6</button>
      <button class="op" onclick="appendCalc('-')">−</button>
      <button onclick="appendCalc('1')">1</button>
      <button onclick="appendCalc('2')">2</button>
      <button onclick="appendCalc('3')">3</button>
      <button class="op" onclick="appendCalc('+')">＋</button>
      <button onclick="appendCalc('0')">0</button>
      <button onclick="appendCalc('.')">.</button>
      <button class="eq" onclick="computeCalc()">=</button>
      <button class="eq" onclick="saveHistory()">保存</button>
      <button class="tax" onclick="applyTax(1.10)">税10%</button>
      <button class="tax" onclick="applyTax(1.08)">税8%</button>
      <button class="tax" onclick="removeTax()">非課税</button>
    </div>
  </div>

  <!-- 右パネル -->
  <div id="right-panel" style="flex-grow:1;">
    <div class="history">
      <h3>計算履歴 (5件まで)</h3>
      <div id="history-list"></div>
    </div>
    <div class="settings">
      <h3>デザイン設定</h3>
      <label>ボタン色: <input type="color" id="btnColor" value="#eeeeee"></label>
      <label>電卓背景色: <input type="color" id="calcBgColor" value="#f5f5f5"></label>
      <label>画面背景色: <input type="color" id="screenBgColor" value="#ffffff"></label>
      <label>背景画像: <input type="file" id="bgFile"></label>
      <button onclick="removeBgImage()">背景画像を削除</button>
    </div>
    <div class="guide">
      <h3>キーボード操作ガイド</h3>
      <ul>
        <li>数字、+ - * / . () で入力</li>
        <li>Enterで計算、Backspaceで削除</li>
      </ul>
    </div>
  </div>
</div>

<script>
(() => {
  let calcFormula = "";
  let calcResult = "";
  const formulaEl = document.getElementById("formula");
  const resultEl = document.getElementById("result");
  const historyListEl = document.getElementById("history-list");
  let historyData = JSON.parse(localStorage.getItem("calc_history") || "[]");

  function updateDisplay() {
    formulaEl.textContent = calcFormula || "式";
    resultEl.textContent = calcResult || "0";
  }

  window.appendCalc = function(val) {
    calcFormula += val;
    updateDisplay();
  };

  window.clearCalc = function() {
    calcFormula = "";
    calcResult = "";
    updateDisplay();
  };

  window.computeCalc = function() {
    try {
      calcResult = eval(calcFormula);
    } catch {
      calcResult = "Error";
    }
    updateDisplay();
  };

  window.applyTax = function(rate) {
    if (calcResult !== "" && !isNaN(calcResult)) {
      calcResult = Math.round(calcResult * rate * 100) / 100;
      updateDisplay();
    } else {
      calcFormula += "*" + rate;
      updateDisplay();
    }
  };

  window.removeTax = function() {
    calcFormula = calcFormula.replace(/\*1\.(10|08)/, "");
    computeCalc();
  };

  window.saveHistory = function() {
    if (!calcFormula) return;
    const entry = { formula: calcFormula, result: calcResult, memo: "" };
    historyData.unshift(entry);
    historyData = historyData.slice(0, 5);
    localStorage.setItem("calc_history", JSON.stringify(historyData));
    renderHistory();
  };

  function renderHistory() {
    historyListEl.innerHTML = "";
    for (let i = 0; i < 5; i++) {
      const item = historyData[i];
      const div = document.createElement("div");
      div.className = "history-item";
      if (item) {
        div.innerHTML = "<strong>" + item.formula + " = " + item.result + "</strong><br>" +
          "<textarea placeholder='メモ'>" + (item.memo || "") + "</textarea>";
        div.querySelector("textarea").addEventListener("change", function() {
          item.memo = this.value;
          localStorage.setItem("calc_history", JSON.stringify(historyData));
        });
      } else {
        div.innerHTML = "<em>空欄</em><br><textarea placeholder='メモ'></textarea>";
      }
      historyListEl.appendChild(div);
    }
  }

  document.getElementById("btnColor").addEventListener("change", function() {
    document.querySelectorAll(".button-grid button").forEach(btn => {
      btn.style.backgroundColor = this.value;
    });
  });
  document.getElementById("calcBgColor").addEventListener("change", function() {
    document.getElementById("toolcalc-app").style.backgroundColor = this.value;
  });
  document.getElementById("screenBgColor").addEventListener("change", function() {
    const main = document.getElementById("main");
    if (main) main.style.backgroundColor = this.value;
  });
  document.getElementById("bgFile").addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        const main = document.getElementById("main");
        if (main) {
          main.style.backgroundImage = "url('" + e.target.result + "')";
          main.style.backgroundSize = "cover";
        }
      };
      reader.readAsDataURL(file);
    }
  });
  window.removeBgImage = function() {
    const main = document.getElementById("main");
    if (main) main.style.backgroundImage = "";
  };

  document.addEventListener("keydown", function(e) {
    const key = e.key;
    if ("0123456789.+-*/()".includes(key)) appendCalc(key);
    else if (key === "Enter") computeCalc();
    else if (key === "Backspace") {
      calcFormula = calcFormula.slice(0, -1);
      updateDisplay();
    }
  });

  updateDisplay();
  renderHistory();
})();
</script>
</body>
</html>
