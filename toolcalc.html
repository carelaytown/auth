<!-- toolcalc_final_full.html -->
<div id="toolcalc-app">
  <style>
    /* コンテナ */
    #toolcalc-app {
      font-family: Arial, sans-serif;
      max-width: 400px;
      margin: 20px auto;
      padding: 16px;
      background: #f5f5f5;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
    /* 表示エリア */
    .display-area {
      margin-bottom: 12px;
    }
    .display-area .formula,
    .display-area .result {
      width: 100%;
      padding: 10px;
      margin-bottom: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: white;
      text-align: right;
    }
    .display-area .formula { font-size: 18px; color: #555; }
    .display-area .result { font-size: 24px; font-weight: bold; }
    /* ボタングリッド */
    .button-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .button-grid button {
      padding: 16px;
      font-size: 18px;
      border: none;
      border-radius: 6px;
      background-color: #eee;
      cursor: pointer;
      transition: transform 0.1s, background 0.1s;
    }
    .button-grid button:active {
      transform: scale(0.95);
    }
    /* オペレーター */
    .button-grid button.op {
      background-color: #d1e7fd;
    }
    .button-grid button.op:active {
      background-color: #aad4fa;
    }
    /* 等号 */
    .button-grid button.eq {
      background-color: #fcd34d;
    }
    .button-grid button.eq:active {
      background-color: #fbbf24;
    }
    /* ACボタン */
    .button-grid button.ac {
      background-color: #fca5a5;
    }
    .button-grid button.ac:active {
      background-color: #f87171;
    }
    /* 税率ボタン */
    .button-grid button.tax {
      background-color: #c7d2fe;
    }
    .button-grid button.tax:active {
      background-color: #a5b4fc;
    }
    /* 計算履歴 */
    .history {
      margin-bottom: 16px;
      background: #fff;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .history h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    .history .history-item {
      margin-bottom: 8px;
      padding: 8px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .history .history-item textarea {
      width: 100%;
      font-size: 14px;
      margin-top: 4px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
    }
    /* デザイン設定 */
    .settings {
      margin-bottom: 16px;
      background: #fff;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .settings h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    .settings label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }
    /* 操作ガイド */
    .guide {
      font-size: 14px;
      color: #555;
    }
    .guide ul {
      list-style: none;
      padding-left: 0;
    }
    .guide li:before {
      content: "• ";
    }
  </style>

  <!-- 表示エリア -->
  <div class="display-area">
    <div class="formula" id="formula">式</div>
    <div class="result" id="result">0</div>
  </div>

  <!-- ボタングリッド -->
  <div class="button-grid">
    <button class="ac" type="button" onclick="clearCalc()">AC</button>
    <button type="button" onclick="appendCalc('(')"> ( </button>
    <button type="button" onclick="appendCalc(')')"> ) </button>
    <button class="op" type="button" onclick="appendCalc('/')">÷</button>

    <button type="button" onclick="appendCalc('7')">7</button>
    <button type="button" onclick="appendCalc('8')">8</button>
    <button type="button" onclick="appendCalc('9')">9</button>
    <button class="op" type="button" onclick="appendCalc('*')">×</button>

    <button type="button" onclick="appendCalc('4')">4</button>
    <button type="button" onclick="appendCalc('5')">5</button>
    <button type="button" onclick="appendCalc('6')">6</button>
    <button class="op" type="button" onclick="appendCalc('-')">−</button>

    <button type="button" onclick="appendCalc('1')">1</button>
    <button type="button" onclick="appendCalc('2')">2</button>
    <button type="button" onclick="appendCalc('3')">3</button>
    <button class="op" type="button" onclick="appendCalc('+')">＋</button>

    <button type="button" onclick="appendCalc('0')">0</button>
    <button type="button" onclick="appendCalc('.')">.</button>
    <button class="eq" type="button" onclick="computeCalc()">=</button>

    <!-- 税率ボタン -->
    <button class="tax" type="button" onclick="applyTax(1.10)">税10%</button>
    <button class="tax" type="button" onclick="applyTax(1.08)">税8%</button>
    <button class="tax" type="button" onclick="removeTax()">非課税</button>
  </div>

  <!-- 計算履歴 -->
  <div class="history">
    <h3>計算履歴 (5件まで)</h3>
    <div id="history-list"></div>
    <button class="eq" type="button" onclick="saveHistory()">保存</button>
  </div>

  <!-- デザイン設定 -->
  <div class="settings">
    <h3>デザイン設定</h3>
    <label>ボタン色: <input type="color" id="btnColor" value="#eee"></label>
    <label>電卓背景色: <input type="color" id="calcBgColor" value="#f5f5f5"></label>
    <label>画面背景色: <input type="color" id="screenBgColor" value="#ffffff"></label>
    <label>背景画像: <input type="file" id="bgFile"></label>
    <button type="button" onclick="removeBgImage()">背景画像を削除</button>
  </div>

  <!-- キーボード操作ガイド -->
  <div class="guide">
    <h3>キーボード操作ガイド</h3>
    <ul>
      <li>数字キー、'+', '-', '*', '/', '.', '(', ')' で入力</li>
      <li>Enterキーで計算、Backspaceキーで削除</li>
    </ul>
  </div>

  <script>
    (() => {
      // 変数定義
      let calcFormula = "";
      let calcResult = "";
      const formulaEl = document.getElementById("formula");
      const resultEl = document.getElementById("result");
      const historyListEl = document.getElementById("history-list");
      let historyData = JSON.parse(localStorage.getItem("calc_history") || "[]");

      // 表示更新
      function updateDisplay() {
        formulaEl.textContent = calcFormula || "式";
        resultEl.textContent = calcResult || "0";
      }

      // 数値・記号の追加
      window.appendCalc = function(val) {
        calcFormula += val;
        updateDisplay();
      };

      // クリア
      window.clearCalc = function() {
        calcFormula = "";
        calcResult = "";
        updateDisplay();
      };

      // 計算実行
      window.computeCalc = function() {
        try {
          calcResult = eval(calcFormula);
        } catch (e) {
          calcResult = "Error";
        }
        updateDisplay();
      };

      // 税率計算（結果が数値の場合のみ適用、または式に乗数を追加）
      window.applyTax = function(rate) {
        if (calcResult !== "" && !isNaN(calcResult)) {
          calcResult = Math.round(calcResult * rate * 100) / 100;
          updateDisplay();
        } else {
          calcFormula += "*" + rate;
          updateDisplay();
        }
      };

      // 非課税（乗数部分を除去して再計算）
      window.removeTax = function() {
        calcFormula = calcFormula.replace(/\*1\.(10|08)/, "");
        computeCalc();
      };

      // 計算履歴保存（最大5件）
      window.saveHistory = function() {
        if (!calcFormula) return;
        const entry = { formula: calcFormula, result: calcResult, memo: "" };
        historyData.unshift(entry);
        if (historyData.length > 5) {
          historyData = historyData.slice(0, 5);
        }
        localStorage.setItem("calc_history", JSON.stringify(historyData));
        renderHistory();
      };

      // 履歴表示
      function renderHistory() {
        historyListEl.innerHTML = "";
        for (let i = 0; i < 5; i++) {
          const item = historyData[i];
          const div = document.createElement("div");
          div.className = "history-item";
          if (item) {
            div.innerHTML = "<strong>" + item.formula + " = " + item.result + "</strong><br>" +
              "<textarea placeholder='メモ'>" + (item.memo || "") + "</textarea>";
            div.querySelector("textarea").addEventListener("change", function() {
              item.memo = this.value;
              localStorage.setItem("calc_history", JSON.stringify(historyData));
            });
          } else {
            div.innerHTML = "<em>空欄</em><br><textarea placeholder='メモ'></textarea>";
          }
          historyListEl.appendChild(div);
        }
      }

      // カラーピッカー設定
      const btnColorInput = document.getElementById("btnColor");
      const calcBgColorInput = document.getElementById("calcBgColor");
      const screenBgColorInput = document.getElementById("screenBgColor");
      const bgFileInput = document.getElementById("bgFile");

      btnColorInput.addEventListener("change", function() {
        document.querySelectorAll(".button-grid button").forEach(btn => {
          btn.style.backgroundColor = this.value;
        });
      });

      calcBgColorInput.addEventListener("change", function() {
        document.getElementById("toolcalc-app").style.backgroundColor = this.value;
      });

      screenBgColorInput.addEventListener("change", function() {
        const mainEl = document.getElementById("main");
        if (mainEl) {
          mainEl.style.backgroundColor = this.value;
        }
      });

      bgFileInput.addEventListener("change", function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const mainEl = document.getElementById("main");
            if (mainEl) {
              mainEl.style.backgroundImage = "url('" + e.target.result + "')";
              mainEl.style.backgroundSize = "cover";
            }
          };
          reader.readAsDataURL(file);
        }
      });

      window.removeBgImage = function() {
        const mainEl = document.getElementById("main");
        if (mainEl) {
          mainEl.style.backgroundImage = "";
        }
      };

      // キーボード操作サポート
      document.addEventListener("keydown", function(e) {
        const key = e.key;
        if ("0123456789.+-*/()".includes(key)) {
          appendCalc(key);
        } else if (key === "Enter") {
          computeCalc();
        } else if (key === "Backspace") {
          calcFormula = calcFormula.slice(0, -1);
          updateDisplay();
        }
      });

      updateDisplay();
      renderHistory();
    })();
  </script>
</div>
