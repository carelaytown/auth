<!DOCTYPE html><html><head><meta charset='UTF-8'><title>電卓アプリ</title></head><body>

<!-- toolcalc-app 全体（左パネル＋右パネル＋スクリプト） -->
<div id="toolcalc-app" style="display:flex; gap:20px; justify-content:center; align-items:flex-start;">
  <!-- 左パネル（省略） -->

  <!-- 右パネル：履歴・設定・操作ガイド -->
  <div id="right-panel" style="flex-grow:1;">
    <div class="history">
      <h3>計算履歴 (5件まで)</h3>
      <div id="history-list"></div>
    </div>

    <div class="settings">
      <h3>デザイン設定</h3>
      <label>ボタン色: <input type="color" id="btnColor" value="#eee"></label>
      <label>電卓背景色: <input type="color" id="calcBgColor" value="#f5f5f5"></label>
      <label>画面背景色: <input type="color" id="screenBgColor" value="#ffffff"></label>
      <label>背景画像: <input type="file" id="bgFile"></label>
      <button type="button" onclick="removeBgImage()">背景画像を削除</button>
    </div>

    <div class="guide">
      <h3>キーボード操作ガイド</h3>
      <ul>
        <li>数字キー、'+', '-', '*', '/', '.', '(', ')' で入力</li>
        <li>Enterキーで計算、Backspaceキーで削除</li>
      </ul>
    </div>
  </div>
</div>

<script>
(() => {
  let calcFormula = "";
  let calcResult = "";
  const formulaEl = document.getElementById("formula");
  const resultEl = document.getElementById("result");
  const historyListEl = document.getElementById("history-list");
  let historyData = JSON.parse(localStorage.getItem("calc_history") || "[]");

  function updateDisplay() {
    formulaEl.textContent = calcFormula || "式";
    resultEl.textContent = calcResult || "0";
  }

  window.appendCalc = function(val) {
    calcFormula += val;
    updateDisplay();
  };

  window.clearCalc = function() {
    calcFormula = "";
    calcResult = "";
    updateDisplay();
  };

  window.computeCalc = function() {
    try {
      calcResult = eval(calcFormula);
    } catch (e) {
      calcResult = "Error";
    }
    updateDisplay();
  };

  window.applyTax = function(rate) {
    if (calcResult !== "" && !isNaN(calcResult)) {
      calcResult = Math.round(calcResult * rate * 100) / 100;
      updateDisplay();
    } else {
      calcFormula += "*" + rate;
      updateDisplay();
    }
  };

  window.removeTax = function() {
    calcFormula = calcFormula.replace(/\*1\.(10|08)/, "");
    computeCalc();
  };

  window.saveHistory = function() {
    if (!calcFormula) return;
    const entry = { formula: calcFormula, result: calcResult, memo: "" };
    historyData.unshift(entry);
    if (historyData.length > 5) {
      historyData = historyData.slice(0, 5);
    }
    localStorage.setItem("calc_history", JSON.stringify(historyData));
    renderHistory();
  };

  function renderHistory() {
    historyListEl.innerHTML = "";
    for (let i = 0; i < 5; i++) {
      const item = historyData[i];
      const div = document.createElement("div");
      div.className = "history-item";
      if (item) {
        div.innerHTML = "<strong>" + item.formula + " = " + item.result + "</strong><br>" +
          "<textarea placeholder='メモ'>" + (item.memo || "") + "</textarea>";
        div.querySelector("textarea").addEventListener("change", function() {
          item.memo = this.value;
          localStorage.setItem("calc_history", JSON.stringify(historyData));
        });
      } else {
        div.innerHTML = "<em>空欄</em><br><textarea placeholder='メモ'></textarea>";
      }
      historyListEl.appendChild(div);
    }
  }

  const btnColorInput = document.getElementById("btnColor");
  const calcBgColorInput = document.getElementById("calcBgColor");
  const screenBgColorInput = document.getElementById("screenBgColor");
  const bgFileInput = document.getElementById("bgFile");

  btnColorInput.addEventListener("change", function() {
    document.querySelectorAll(".button-grid button").forEach(btn => {
      btn.style.backgroundColor = this.value;
    });
  });

  calcBgColorInput.addEventListener("change", function() {
    document.getElementById("toolcalc-app").style.backgroundColor = this.value;
  });

  screenBgColorInput.addEventListener("change", function() {
    const mainEl = document.getElementById("main");
    if (mainEl) {
      mainEl.style.backgroundColor = this.value;
    }
  });

  bgFileInput.addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const mainEl = document.getElementById("main");
        if (mainEl) {
          mainEl.style.backgroundImage = "url('" + e.target.result + "')";
          mainEl.style.backgroundSize = "cover";
        }
      };
      reader.readAsDataURL(file);
    }
  });

  window.removeBgImage = function() {
    const mainEl = document.getElementById("main");
    if (mainEl) {
      mainEl.style.backgroundImage = "";
    }
  };

  document.addEventListener("keydown", function(e) {
    const key = e.key;
    if ("0123456789.+-*/()".includes(key)) {
      appendCalc(key);
    } else if (key === "Enter") {
      computeCalc();
    } else if (key === "Backspace") {
      calcFormula = calcFormula.slice(0, -1);
      updateDisplay();
    }
  });

  updateDisplay();
  renderHistory();
})();
</script>

</body></html>
