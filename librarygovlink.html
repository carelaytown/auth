
<div id="librarygovlink-app">
  <h1>è¡Œæ”¿ãƒ»è‡ªæ²»ä½“ãƒªãƒ³ã‚¯é›† ğŸ›ï¸</h1>
  <div class="search">
    <select id="pref-select">
      <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
    </select>
    <button id="search-button">æ¤œç´¢</button>
  </div>
  <div id="link-list"></div>
</div>

<style>
  #librarygovlink-app {
    font-family: 'Segoe UI', sans-serif;
    padding: 1rem;
  }
  #librarygovlink-app h1 {
    text-align: center;
  }
  #librarygovlink-app .search {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin: 1rem 0;
  }
  #librarygovlink-app select,
  #librarygovlink-app button {
    padding: 0.5rem;
    font-size: 1rem;
  }
  #librarygovlink-app .card {
    border: 1px solid #ccc;
    border-left: 10px solid var(--region-color);
    border-radius: 1rem;
    padding: 1rem;
    margin: 1rem auto;
    max-width: 700px;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
  }
  #librarygovlink-app .favorite {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 1.5rem;
    cursor: pointer;
    color: orange;
  }
  #librarygovlink-app input[type="text"] {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  #librarygovlink-app .admin-section {
    margin-top: 1rem;
    border-top: 1px dashed #ccc;
    padding-top: 1rem;
  }
</style>

<script>
(() => {
  const supabaseUrl = "https://viihcgkjzzhkdiwdzdex.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
  const userId = localStorage.getItem("carelay_user_id");
  let isAdmin = false;
  let allData = [];
  let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

  const prefOrder = [
    ["01", "åŒ—æµ·é“"],["02", "é’æ£®çœŒ"],["03", "å²©æ‰‹çœŒ"],["04", "å®®åŸçœŒ"],["05", "ç§‹ç”°çœŒ"],
    ["06", "å±±å½¢çœŒ"],["07", "ç¦å³¶çœŒ"],["08", "èŒ¨åŸçœŒ"],["09", "æ ƒæœ¨çœŒ"],["10", "ç¾¤é¦¬çœŒ"],
    ["11", "åŸ¼ç‰çœŒ"],["12", "åƒè‘‰çœŒ"],["13", "æ±äº¬éƒ½"],["14", "ç¥å¥ˆå·çœŒ"],["15", "æ–°æ½ŸçœŒ"],
    ["16", "å¯Œå±±çœŒ"],["17", "çŸ³å·çœŒ"],["18", "ç¦äº•çœŒ"],["19", "å±±æ¢¨çœŒ"],["20", "é•·é‡çœŒ"],
    ["21", "å²é˜œçœŒ"],["22", "é™å²¡çœŒ"],["23", "æ„›çŸ¥çœŒ"],["24", "ä¸‰é‡çœŒ"],["25", "æ»‹è³€çœŒ"],
    ["26", "äº¬éƒ½åºœ"],["27", "å¤§é˜ªåºœ"],["28", "å…µåº«çœŒ"],["29", "å¥ˆè‰¯çœŒ"],["30", "å’Œæ­Œå±±çœŒ"],
    ["31", "é³¥å–çœŒ"],["32", "å³¶æ ¹çœŒ"],["33", "å²¡å±±çœŒ"],["34", "åºƒå³¶çœŒ"],["35", "å±±å£çœŒ"],
    ["36", "å¾³å³¶çœŒ"],["37", "é¦™å·çœŒ"],["38", "æ„›åª›çœŒ"],["39", "é«˜çŸ¥çœŒ"],["40", "ç¦å²¡çœŒ"],
    ["41", "ä½è³€çœŒ"],["42", "é•·å´çœŒ"],["43", "ç†Šæœ¬çœŒ"],["44", "å¤§åˆ†çœŒ"],["45", "å®®å´çœŒ"],
    ["46", "é¹¿å…å³¶çœŒ"],["47", "æ²–ç¸„çœŒ"]
  ];

  async function checkAdmin() {
    const { data } = await supabase.from("applications").select("is_admin").eq("user_id", userId).single();
    isAdmin = data?.is_admin || false;
  }

  function renderCard(record) {
    const card = document.createElement("div");
    card.className = "card";
    card.style.setProperty("--region-color", "#f0f0f0");

    card.innerHTML = `<h3>${record.pref_name} ${record.city_name}</h3>`;

    const fav = document.createElement("div");
    fav.className = "favorite";
    fav.textContent = favorites.includes(record.municipality_code) ? "â˜…" : "â˜†";
    fav.onclick = () => toggleFavorite(record.municipality_code);
    card.appendChild(fav);

    for (let i = 1; i <= 3; i++) {
      if (record[`link_url_${i}`]) {
        const a = document.createElement("a");
        a.href = record[`link_url_${i}`];
        a.textContent = record[`link_title_${i}`] || record[`link_url_${i}`];
        a.target = "_blank";
        card.appendChild(a);
        card.appendChild(document.createElement("br"));
      }
    }

    if (isAdmin) {
      const adminSection = document.createElement("div");
      adminSection.className = "admin-section";

      for (let i = 1; i <= 3; i++) {
        const title = document.createElement("input");
        title.type = "text";
        title.value = record[`link_title_${i}`] || "";
        title.placeholder = `ãƒªãƒ³ã‚¯${i}ã‚¿ã‚¤ãƒˆãƒ«`;

        const url = document.createElement("input");
        url.type = "text";
        url.value = record[`link_url_${i}`] || "";
        url.placeholder = `ãƒªãƒ³ã‚¯${i}URL`;

        adminSection.appendChild(title);
        adminSection.appendChild(url);
        adminSection.appendChild(document.createElement("br"));

        record[`input_title_${i}`] = title;
        record[`input_url_${i}`] = url;
      }

      const save = document.createElement("button");
      save.textContent = "ä¿å­˜";
      save.onclick = async () => {
        const updateData = { id: record.id };
        for (let i = 1; i <= 3; i++) {
          updateData[`link_title_${i}`] = record[`input_title_${i}`].value;
          updateData[`link_url_${i}`] = record[`input_url_${i}`].value;
        }
        await supabase.from("librarygovlink").upsert(updateData);
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
        loadData();
      };
      adminSection.appendChild(save);
      card.appendChild(adminSection);
    }

    return card;
  }

  function toggleFavorite(code) {
    if (favorites.includes(code)) {
      favorites = favorites.filter(c => c !== code);
    } else {
      favorites.push(code);
    }
    localStorage.setItem("favorites", JSON.stringify(favorites));
    render();
  }

  function render() {
    const list = document.getElementById("link-list");
    list.innerHTML = "";
    const selectedPref = document.getElementById("pref-select").value;
    const special = allData.filter(d => d.municipality_code === "00000" || favorites.includes(d.municipality_code));
    special.forEach(d => list.appendChild(renderCard(d)));

    const filtered = allData
      .filter(d => d.pref_name === selectedPref && !favorites.includes(d.municipality_code) && d.municipality_code !== "00000")
      .sort((a, b) => a.municipality_code.localeCompare(b.municipality_code));
    filtered.forEach(d => list.appendChild(renderCard(d)));
  }

  async function loadData() {
    await checkAdmin();
    const { data } = await supabase.from("librarygovlink").select("*");
    allData = data;
    const sel = document.getElementById("pref-select");
    prefOrder.forEach(([code, name]) => {
      if (data.some(d => d.pref_name === name)) {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      }
    });
    render();
  }

  document.getElementById("search-button").onclick = render;
  loadData();
})();
</script>
