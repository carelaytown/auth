<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CARELAYã‚¿ã‚¦ãƒ³ åˆ©ç”¨é–‹å§‹</title>
  <style>
    body { margin: 0; font-family: 'Noto Sans JP', sans-serif; background: #f0f6ff; color: #333; }
    .header { background-color: #2a6ebb; color: white; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; }
    .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; padding: 40px 20px; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 30px; width: 360px; max-width: 90%; }
    .card h2 { margin-top: 0; font-size: 20px; color: #2a6ebb; }
    input[type="text"], input[type="email"], input[type="password"] {
      width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;
    }
    button { margin-top: 20px; padding: 10px 20px; background-color: #2a6ebb; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
    button:hover { background-color: #1f5aa0; }
    .status { margin-top: 15px; font-weight: bold; font-size: 13px; }
    .error { color: #c0392b; }
    .success { color: #27ae60; }
    .pending { color: #f39c12; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="header">CARELAY TOWN åˆ©ç”¨é–‹å§‹</div>
<div class="container">
  <!-- åˆ©ç”¨ç”³ã—è¾¼ã¿ -->
  <div class="card">
    <h2>ğŸ“ åˆ©ç”¨ç”³ã—è¾¼ã¿</h2>
    <input type="text" id="orgName" placeholder="äº‹æ¥­æ‰€å" />
    <input type="email" id="regEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
    <input type="password" id="regPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" />
    <button onclick="submitApplication(event)">ç”³è«‹ã™ã‚‹</button>
    <div id="applyStatus" class="status"></div>
  </div>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
  <div class="card">
    <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <input type="email" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
    <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div id="loginStatus" class="status"></div>
  </div>
</div>
<script>
const supabase = window.supabase.createClient(
  "https://viihcgkjzzhkdiwdzdex.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM"
);

window.onload = () => {
  supabase.auth.getSession().then(({ data }) => {
    const session = data.session;
    const approved = localStorage.getItem("carelayApproved");
    const email = localStorage.getItem("carelayUser");
    if (session && approved === "ok" && email) {
      window.location.href = "top.html";
    }
  }).catch(err => {
    console.error("ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
  });
};

async function submitApplication(e) {
  const orgName = document.getElementById("orgName").value.trim();
  const email = document.getElementById("regEmail").value.trim().toLowerCase();
  const password = document.getElementById("regPassword").value.trim();
  const statusDiv = document.getElementById("applyStatus");
  const button = e.target;

  statusDiv.innerText = ""; statusDiv.className = "status";
  if (!orgName || !email || password.length < 6) {
    statusDiv.innerText = "âŒ å¿…è¦æƒ…å ±ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    statusDiv.classList.add("error"); return;
  }

  button.disabled = true; button.innerText = "ç”³è«‹ä¸­...";

  const { error: signupError } = await supabase.auth.signUp({ email, password });
  if (signupError) {
    statusDiv.innerText = `âŒ ç™»éŒ²å¤±æ•—: ${signupError.message}`;
    statusDiv.classList.add("error"); button.disabled = false; button.innerText = "ç”³è«‹ã™ã‚‹"; return;
  }

  const { error: insertError } = await supabase.from("applications").insert({ email, org_name: orgName, status: "pending" });
  if (insertError) {
    statusDiv.innerText = "âŒ ç”³è«‹ãƒ‡ãƒ¼ã‚¿ç™»éŒ²å¤±æ•—ã€‚";
    statusDiv.classList.add("error"); button.disabled = false; button.innerText = "ç”³è«‹ã™ã‚‹"; return;
  }

  statusDiv.innerText = "âœ… ç”³è«‹å®Œäº†ã€‚æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚";
  statusDiv.classList.add("success");
  document.getElementById("orgName").disabled = true;
  document.getElementById("regEmail").disabled = true;
  document.getElementById("regPassword").disabled = true;
}

async function login() {
  const email = document.getElementById("loginEmail").value.trim().toLowerCase();
  const password = document.getElementById("loginPassword").value.trim();
  const statusDiv = document.getElementById("loginStatus");

  statusDiv.innerText = ""; statusDiv.className = "status";
  if (!email || !password) {
    statusDiv.innerText = "âŒ ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    statusDiv.classList.add("error"); return;
  }

  const { error: loginError } = await supabase.auth.signInWithPassword({ email, password });
  if (loginError) {
    statusDiv.innerText = `âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${loginError.message}`;
    statusDiv.classList.add("error"); return;
  }

  const { data, error } = await supabase.from("applications").select().eq("email", email).eq("status", "approved");
  if (error || !data || data.length === 0) {
    statusDiv.innerText = "âŒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
    statusDiv.classList.add("error"); return;
  }

  if (data[0].status === "approved") {
    localStorage.setItem("carelayUser", email);
    localStorage.setItem("carelayApproved", "ok");
    window.location.href = "top.html";
  } else {
    statusDiv.innerText = "âš ï¸ æ‰¿èªå¾…ã¡ã§ã™ã€‚";
    statusDiv.classList.add("pending");
  }
}
</script>
</body>
</html>
