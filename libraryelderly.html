<style>
  #libraryelderly-app {
    background: white;
    padding: 1em;
    font-family: sans-serif;
  }
  h2 { margin-bottom: 0.3em; }
  p.note { font-size: 0.9em; color: #555; margin-top: 0; }
  label, select, button { margin-right: 1em; margin-bottom: 0.5em; }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 1em;
    border: 1px solid #ccc;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 4px 8px;
    text-align: left;
  }
  tr:nth-child(even) {
    background: #f9f9f9;
  }
  .pagination {
    margin-top: 1em;
    text-align: center;
  }
</style>

<div id="libraryelderly-app">
  <h2>介護事業所検索（高齢者）</h2>
  <p class="note">このデータは高齢労働省のオープンデータ（2024年12月末時点）を使用しています</p>

  <div>
    <label for="prefSelect">都道府県：</label>
    <select id="prefSelect"><option value="">すべて</option></select>

    <label for="citySelect">市区町村：</label>
    <select id="citySelect"><option value="">すべて</option></select>

    <label for="serviceSelect">サービス種別：</label>
    <select id="serviceSelect"><option value="">すべて</option></select>

    <button id="searchBtn">表示</button>
  </div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>#</th><th>事業所名</th><th>サービス</th><th>電話番号</th><th>FAX</th><th>Email</th>
        <th>住所</th><th>事業所番号</th><th>法人名</th><th>URL</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button id="prevPage">前へ</button>
    <span id="pageInfo">ページ 1</span>
    <button id="nextPage">次へ</button>
  </div>
</div>

<script>
(() => {
  const supabase = window.supabase.createClient(
    "https://viihcgkjzzhkdiwdzdex.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM"
  );

  const prefSel = document.getElementById("prefSelect");
  const citySel = document.getElementById("citySelect");
  const servSel = document.getElementById("serviceSelect");
  const searchBtn = document.getElementById("searchBtn");
  const tbody = document.querySelector("#resultTable tbody");
  const prevBtn = document.getElementById("prevPage");
  const nextBtn = document.getElementById("nextPage");
  const pageInfo = document.getElementById("pageInfo");

  let allData = [], filteredData = [], page = 0, limit = 100;

  async function initSelectors() {
    const { data, error } = await supabase.from("facilities").select("prefecture, city, service_type").limit(1000);
    if (error) return console.error("フィルター抽出エラー:", error);

    const prefs = new Set(), cities = new Set(), services = new Set();
    data.forEach(d => {
      if (d.prefecture && d.prefecture.trim()) prefs.add(d.prefecture.trim());
      if (d.city && d.city.trim()) cities.add(d.city.trim());
      if (d.service_type && d.service_type.trim()) services.add(d.service_type.trim());
    });

    [...prefs].sort().forEach(p => prefSel.innerHTML += `<option>${p}</option>`);
    [...cities].sort().forEach(c => citySel.innerHTML += `<option>${c}</option>`);
    [...services].sort().forEach(s => servSel.innerHTML += `<option>${s}</option>`);
  }

  async function searchFacilities() {
    page = 0;
    let query = supabase.from("facilities").select("*").limit(1000);
    const { data, error } = await query;
    if (error) return console.error("取得エラー:", error);
    allData = data;
    applyFilters();
  }

  function applyFilters() {
    filteredData = allData.filter(x =>
      (!prefSel.value || x.prefecture === prefSel.value) &&
      (!citySel.value || x.city === citySel.value) &&
      (!servSel.value || x.service_type === servSel.value)
    );
    renderPage();
  }

  function renderPage() {
    tbody.innerHTML = "";
    const start = page * limit;
    const paged = filteredData.slice(start, start + limit);
    paged.forEach((item, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${start + idx + 1}</td>
        <td>${item.office_name || ""}</td>
        <td>${item.service_type || ""}</td>
        <td>${item.phone || ""}</td>
        <td>${item.fax || ""}</td>
        <td>${item.email || ""}</td>
        <td>${item.address || ""}</td>
        <td>${item.office_number || ""}</td>
        <td>${item.organization_name || ""}</td>
        <td>${item.url ? `<a href="${item.url}" target="_blank">リンク</a>` : ""}</td>
      `;
      tbody.appendChild(tr);
    });

    pageInfo.textContent = `ページ ${page + 1} / ${Math.ceil(filteredData.length / limit)}`;
    prevBtn.disabled = page === 0;
    nextBtn.disabled = start + limit >= filteredData.length;
  }

  prevBtn.onclick = () => { if (page > 0) { page--; renderPage(); } };
  nextBtn.onclick = () => { if ((page + 1) * limit < filteredData.length) { page++; renderPage(); } };
  searchBtn.onclick = () => searchFacilities();

  window.addEventListener("DOMContentLoaded", initSelectors);
})();
</script>
