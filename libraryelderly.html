<!-- 完全動作版：supabase変数未使用、安全なclient命名、JS構文エラー回避済み -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  if (!window.supabaseClient) {
    window.supabaseClient = window.supabase.createClient(
      'https://udcrfwejohzmhfojnwha.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkY3Jmd2Vqb2h6bWhmb2pud2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5ODk1NzgsImV4cCI6MjA2MTU2NTU3OH0.dqy_L8iPlbUDoozkha4yjar4ADvinxGc0a6ygSuBLQI'
    );
  }

  const client = window.supabaseClient;
  const pageSize = 1000;
  let fullData = [], currentPage = 1;

  const tablePrefixMap = {
    "北海道": "01_hokkaido", "青森県": "02_aomori"
    // 他の都道府県も追加可能
  };

  document.addEventListener('DOMContentLoaded', () => {
    const prefSelect = document.getElementById('prefecture');
    Object.keys(tablePrefixMap).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p; opt.textContent = p;
      prefSelect.appendChild(opt);
    });

    prefSelect.addEventListener('change', loadFilters);
    document.getElementById('search-btn').addEventListener('click', searchData);
    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; renderTable(); }
    });
    document.getElementById('next-page').addEventListener('click', () => {
      if (currentPage < Math.ceil(fullData.length / pageSize)) {
        currentPage++; renderTable();
      }
    });
  });

  async function loadFilters() {
    const pref = document.getElementById('prefecture').value;
    const citySel = document.getElementById('city');
    const serviceSel = document.getElementById('service');
    citySel.innerHTML = '<option>市区町村</option>';
    serviceSel.innerHTML = '<option>サービスの種別</option>';
    const table = tablePrefixMap[pref];
    const { data: cityData } = await client.from(table).select('city').limit(10000);
    const { data: serviceData } = await client.from(table).select('service_type').limit(10000);
    const cities = [...new Set((cityData || []).map(d => d.city).filter(Boolean))];
    const services = [...new Set((serviceData || []).map(d => d.service_type).filter(Boolean))];
    cities.sort().forEach(c => citySel.innerHTML += `<option>${c}</option>`);
    services.sort().forEach(s => serviceSel.innerHTML += `<option>${s}</option>`);
  }

  async function searchData() {
    const pref = document.getElementById('prefecture').value;
    const city = document.getElementById('city').value;
    const service = document.getElementById('service').value;
    const table = tablePrefixMap[pref];
    let query = client.from(table).select('*').limit(10000);
    if (city !== '市区町村') query = query.eq('city', city);
    if (service !== 'サービスの種別') query = query.eq('service_type', service);
    const { data, error } = await query;
    if (!error && data) {
      fullData = data; currentPage = 1; renderTable();
    }
  }

  function renderTable() {
    const tbody = document.querySelector('#results-table tbody');
    tbody.innerHTML = '';
    const start = (currentPage - 1) * pageSize;
    const pageData = fullData.slice(start, start + pageSize);
    pageData.forEach((r, i) => {
      const row = `<tr>
        <td>${start + i + 1}</td><td>${r.office_name}</td><td>${r.service_type}</td>
        <td>${r.phone}</td><td>${r.fax}</td><td>${r.email}</td><td>${r.address}</td>
        <td>${r.office_number}</td><td>${r.organization_name}</td>
        <td>${r.url ? `<a href="${r.url}" target="_blank">リンク</a>` : ''}</td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
    document.getElementById('page-info').textContent =
      `${currentPage}/${Math.ceil(fullData.length / pageSize)}ページ`;
  }
</script>
