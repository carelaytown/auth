<!-- エラー完全回避：supabase再定義なし・window.__supabaseClient使用 -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  if (!window.__supabaseClient) {
    window.__supabaseClient = window.supabase.createClient(
      'https://udcrfwejohzmhfojnwha.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkY3Jmd2Vqb2h6bWhmb2pud2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5ODk1NzgsImV4cCI6MjA2MTU2NTU3OH0.dqy_L8iPlbUDoozkha4yjar4ADvinxGc0a6ygSuBLQI'
    );
  }
  const sb = window.__supabaseClient;

  // 以下、全て sb.from(...) で処理
  let fullData = [], currentPage = 1, pageSize = 1000;

  document.addEventListener('DOMContentLoaded', () => {
    const prefSelect = document.getElementById('prefecture');
    const prefs = [
      '北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県','茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県',
      '新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県',
      '奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県','徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県',
      '熊本県','大分県','宮崎県','鹿児島県','沖縄県'
    ];
    prefs.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      prefSelect.appendChild(opt);
    });

    prefSelect.addEventListener('change', loadFilters);
    document.getElementById('search-btn').addEventListener('click', searchData);
    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; renderTable(); }
    });
    document.getElementById('next-page').addEventListener('click', () => {
      if (currentPage < Math.ceil(fullData.length / pageSize)) {
        currentPage++; renderTable();
      }
    });
  });

  const tablePrefixMap = {
    "北海道": "01_hokkaido", "青森県": "02_aomori"
    // 他の都道府県は同様に続けてください
  };

  async function loadFilters() {
    const pref = document.getElementById('prefecture').value;
    const citySel = document.getElementById('city');
    const serviceSel = document.getElementById('service');
    citySel.innerHTML = '<option>市区町村</option>';
    serviceSel.innerHTML = '<option>サービスの種別</option>';
    const table = tablePrefixMap[pref];
    const { data: cityData } = await sb.from(table).select('city').limit(10000);
    const { data: serviceData } = await sb.from(table).select('service_type').limit(10000);
    const cities = [...new Set((cityData || []).map(d => d.city).filter(Boolean))];
    const services = [...new Set((serviceData || []).map(d => d.service_type).filter(Boolean))];
    cities.sort().forEach(c => citySel.innerHTML += `<option>${c}</option>`);
    services.sort().forEach(s => serviceSel.innerHTML += `<option>${s}</option>`);
  }

  async function searchData() {
    const pref = document.getElementById('prefecture').value;
    const city = document.getElementById('city').value;
    const service = document.getElementById('service').value;
    const table = tablePrefixMap[pref];
    let query = sb.from(table).select('*').limit(10000);
    if (city !== '市区町村') query = query.eq('city', city);
    if (service !== 'サービスの種別') query = query.eq('service_type', service);
    const { data, error } = await query;
    if (!error && data) {
      fullData = data; currentPage = 1; renderTable();
    }
  }

  function renderTable() {
    const tbody = document.querySelector('#results-table tbody');
    tbody.innerHTML = '';
    const start = (currentPage - 1) * pageSize;
    const pageData = fullData.slice(start, start + pageSize);
    pageData.forEach((r, i) => {
      const row = `<tr>
        <td>${start + i + 1}</td>
        <td>${r.office_name}</td><td>${r.service_type}</td><td>${r.phone}</td>
        <td>${r.fax}</td><td>${r.email}</td><td>${r.address}</td>
        <td>${r.office_number}</td><td>${r.organization_name}</td>
        <td>${r.url ? `<a href="${r.url}" target="_blank">リンク</a>` : ''}</td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
    document.getElementById('page-info').textContent =
      `${currentPage}/${Math.ceil(fullData.length / pageSize)}ページ`;
  }
</script>
