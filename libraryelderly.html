<style>
  body {
    background-color: white;
    font-family: Arial, sans-serif;
  }
  h2 {
    font-size: 24px;
    font-weight: bold;
  }
  .note {
    font-size: 12px;
    color: #555;
    margin-bottom: 20px;
  }
  .filters {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  select, button {
    padding: 6px 10px;
    font-size: 14px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
  }
  table, th, td {
    border: 1px solid #ccc;
  }
  th, td {
    padding: 6px 8px;
    text-align: left;
    white-space: nowrap;
  }
  .pagination {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
  }
</style>

<h2>介護事業所検索（高齢者）</h2>
<p class="note">このデータは高齢労働省のオープンデータ（2024年12月末時点）を使用しています</p>

<div class="filters">
  <select id="prefecture">
    <option value="">都道府県を選択</option>
  </select>
  <select id="city">
    <option value="">市区町村を選択</option>
  </select>
  <select id="serviceType">
    <option value="">サービスの種類を選択</option>
  </select>
  <button onclick="applyFilters()">表示</button>
</div>

<div id="tableContainer"></div>
<div class="pagination" id="pagination"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.js"></script>
<script>
  const supabase = window.supabase.createClient(
    'https://udcrfwejohzmhfojnwha.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkY3Jmd2Vqb2h6bWhmb2pud2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5ODk1NzgsImV4cCI6MjA2MTU2NTU3OH0.dqy_L8iPlbUDoozkha4yjar4ADvinxGc0a6ygSuBLQI'
  );

  const rowsPerPage = 100;
  let currentPage = 1;
  let totalPages = 1;
  let allData = [];

  document.addEventListener('DOMContentLoaded', async () => {
    const prefSelect = document.getElementById('prefecture');
    const prefectures = [
      '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
      '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
      '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県',
      '岐阜県', '静岡県', '愛知県', '三重県',
      '滋賀県', '京都府', '大阪府', '兵庫県', '奈良県', '和歌山県',
      '鳥取県', '島根県', '岡山県', '広島県', '山口県',
      '徳島県', '香川県', '愛媛県', '高知県',
      '福岡県', '佐賀県', '長崎県', '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'
    ];
    prefSelect.innerHTML += prefectures.map(p => `<option value="${p}">${p}</option>`).join('');
  });

  async function applyFilters() {
    const pref = document.getElementById('prefecture').value;
    const city = document.getElementById('city').value;
    const service = document.getElementById('serviceType').value;

    if (!pref) return;

    const tableName = getTableName(pref);
    let query = supabase.from(tableName).select('*', { count: 'exact' });

    if (city) query = query.eq('city', city);
    if (service) query = query.eq('service_type', service);

    const { data, error, count } = await query.range(0, 999);

    if (error) return console.error(error);

    allData = data;
    currentPage = 1;
    totalPages = Math.ceil(count / rowsPerPage);
    renderTable();
    renderPagination();
    loadCityAndService(pref, data);
  }

  function getTableName(pref) {
    const map = {
      '北海道': '01_hokkaido', '青森県': '02_aomori', '岩手県': '03_iwate', '宮城県': '04_miyagi',
      '秋田県': '05_akita', '山形県': '06_yamagata', '福島県': '07_fukushima',
      '茨城県': '08_ibaraki', '栃木県': '09_tochigi', '群馬県': '10_gunma', '埼玉県': '11_saitama',
      '千葉県': '12_chiba', '東京都': '13_tokyo', '神奈川県': '14_kanagawa',
      '新潟県': '15_niigata', '富山県': '16_toyama', '石川県': '17_ishikawa', '福井県': '18_fukui',
      '山梨県': '19_yamanashi', '長野県': '20_nagano',
      '岐阜県': '21_gifu', '静岡県': '22_shizuoka', '愛知県': '23_aichi', '三重県': '24_mie',
      '滋賀県': '25_shiga', '京都府': '26_kyoto', '大阪府': '27_osaka', '兵庫県': '28_hyogo',
      '奈良県': '29_nara', '和歌山県': '30_wakayama',
      '鳥取県': '31_tottori', '島根県': '32_shimane', '岡山県': '33_okayama', '広島県': '34_hiroshima', '山口県': '35_yamaguchi',
      '徳島県': '36_tokushima', '香川県': '37_kagawa', '愛媛県': '38_ehime', '高知県': '39_kochi',
      '福岡県': '40_fukuoka', '佐賀県': '41_saga', '長崎県': '42_nagasaki', '熊本県': '43_kumamoto',
      '大分県': '44_oita', '宮崎県': '45_miyazaki', '鹿児島県': '46_kagoshima', '沖縄県': '47_okinawa'
    };
    return map[pref];
  }

  function loadCityAndService(pref, data) {
    const citySelect = document.getElementById('city');
    const serviceSelect = document.getElementById('serviceType');
    const cities = [...new Set(data.map(d => d.city))].filter(Boolean);
    const services = [...new Set(data.map(d => d.service_type))].filter(Boolean);

    citySelect.innerHTML = '<option value="">市区町村を選択</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');
    serviceSelect.innerHTML = '<option value="">サービスの種類を選択</option>' + services.map(s => `<option value="${s}">${s}</option>`).join('');
  }

  function renderTable() {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const data = allData.slice(start, end);
    const container = document.getElementById('tableContainer');
    if (!data.length) return container.innerHTML = "<p>データが見つかりませんでした。</p>";

    let html = '<table><thead><tr>';
    html += ['No', '事業所名', 'サービスの種類', '電話番号', 'FAX番号', 'Email', '住所', '事業所番号', '法人名称', 'ホームページ'].map(h => `<th>${h}</th>`).join('');
    html += '</tr></thead><tbody>';
    html += data.map((row, i) => `
      <tr>
        <td>${start + i + 1}</td>
        <td>${row.office_name}</td>
        <td>${row.service_type}</td>
        <td>${row.phone}</td>
        <td>${row.fax}</td>
        <td>${row.email}</td>
        <td>${row.address}</td>
        <td>${row.office_number}</td>
        <td>${row.organization_name}</td>
        <td>${row.url}</td>
      </tr>
    `).join('');
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function renderPagination() {
    const pagination = document.getElementById('pagination');
    if (totalPages <= 1) return pagination.innerHTML = '';

    pagination.innerHTML = `
      <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>◁</button>
      ${currentPage} / ${totalPages}ページ
      <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>▷</button>
    `;
  }

  function changePage(offset) {
    currentPage += offset;
    renderTable();
    renderPagination();
  }
</script>
