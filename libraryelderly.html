<style>
  body {
    background-color: white;
    font-family: sans-serif;
  }
  .filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin: 1rem 0;
  }
  .filter-container select, .filter-container button {
    padding: 0.5rem;
    font-size: 1rem;
  }
  .result-count {
    margin-bottom: 0.5rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 0.5rem;
    text-align: left;
    word-wrap: break-word;
  }
  th {
    background-color: #f9f9f9;
  }
  .pagination {
    margin-top: 0.5rem;
    text-align: center;
  }
  .pagination button {
    margin: 0 1rem;
    padding: 0.5rem 1rem;
    font-size: 1rem;
  }
</style>

<div>
  <h2>介護事業所検索（高齢者）</h2>
  <p>このデータは高齢労働省のオープンデータ（2024年12月末時点）を使用しています</p>

  <div class="filter-container">
    <select id="prefSelect"><option value="">都道府県を選択</option></select>
    <select id="citySelect"><option value="">市区町村を選択</option></select>
    <select id="serviceSelect"><option value="">サービスの種別を選択</option></select>
    <button id="filterBtn">表示</button>
  </div>

  <div class="result-count" id="resultCount"></div>
  <table>
    <thead>
      <tr>
        <th>No</th><th>事業所名</th><th>サービスの種類</th><th>電話番号</th><th>FAX番号</th>
        <th>Email</th><th>住所</th><th>事業所番号</th><th>法人名称</th><th>ホームページ</th>
      </tr>
    </thead>
    <tbody id="resultTable"></tbody>
  </table>

  <div class="pagination">
    <button id="prevPage">◁</button>
    <span id="pageInfo"></span>
    <button id="nextPage">▷</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient(
    'https://udcrfwejohzmhfojnwha.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkY3Jmd2Vqb2h6bWhmb2pud2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5ODk1NzgsImV4cCI6MjA2MTU2NTU3OH0.dqy_L8iPlbUDoozkha4yjar4ADvinxGc0a6ygSuBLQI'
  );

  const tablePrefix = ""; // ex: "01_hokkaido"
  let currentPage = 1;
  let totalPage = 1;
  let currentData = [];

  const prefMap = {
    "北海道": "01_hokkaido",
    "青森県": "02_aomori",
    // 全47都道府県分を記述
  };

  document.addEventListener('DOMContentLoaded', async () => {
    const prefSelect = document.getElementById('prefSelect');
    Object.keys(prefMap).forEach(pref => {
      const option = document.createElement('option');
      option.value = pref;
      option.textContent = pref;
      prefSelect.appendChild(option);
    });

    document.getElementById('filterBtn').addEventListener('click', () => {
      currentPage = 1;
      fetchData();
    });

    document.getElementById('prefSelect').addEventListener('change', async () => {
      const pref = prefMap[prefSelect.value];
      if (!pref) return;
      const { data } = await supabase.from(pref).select('city, service_type').range(0, 9999);
      const cities = [...new Set(data.map(x => x.city))].sort();
      const services = [...new Set(data.map(x => x.service_type))].sort();

      const citySelect = document.getElementById('citySelect');
      citySelect.innerHTML = '<option value="">市区町村を選択</option>';
      cities.forEach(c => citySelect.innerHTML += `<option value="${c}">${c}</option>`);

      const serviceSelect = document.getElementById('serviceSelect');
      serviceSelect.innerHTML = '<option value="">サービスの種別を選択</option>';
      services.forEach(s => serviceSelect.innerHTML += `<option value="${s}">${s}</option>`);
    });

    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      if (currentPage < totalPage) {
        currentPage++;
        renderTable();
      }
    });
  });

  async function fetchData() {
    const pref = document.getElementById('prefSelect').value;
    const city = document.getElementById('citySelect').value;
    const service = document.getElementById('serviceSelect').value;
    const table = prefMap[pref];
    if (!table) return;

    let query = supabase.from(table).select('*').limit(10000);
    if (city) query = query.eq('city', city);
    if (service) query = query.eq('service_type', service);

    const { data } = await query;
    currentData = data;
    currentPage = 1;
    totalPage = Math.ceil(currentData.length / 1000);
    renderTable();
  }

  function renderTable() {
    const start = (currentPage - 1) * 1000;
    const end = start + 1000;
    const data = currentData.slice(start, end);

    const table = document.getElementById('resultTable');
    const resultCount = document.getElementById('resultCount');
    const pageInfo = document.getElementById('pageInfo');

    table.innerHTML = '';
    data.forEach((row, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${start + index + 1}</td>
        <td>${row.office_name}</td>
        <td>${row.service_type}</td>
        <td>${row.phone}</td>
        <td>${row.fax}</td>
        <td>${row.email}</td>
        <td>${row.address}</td>
        <td>${row.office_number}</td>
        <td>${row.organization_name}</td>
        <td>${row.url}</td>`;
      table.appendChild(tr);
    });
    resultCount.textContent = `該当件数: ${currentData.length}`;
    pageInfo.textContent = `${currentPage} / ${totalPage} ページ`;
  }
</script>
