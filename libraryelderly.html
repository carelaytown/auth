<style>
  body {
    font-family: sans-serif;
    background: white;
    margin: 0;
    padding: 1em;
  }
  h2 {
    font-size: 20px;
    margin-bottom: 0.2em;
  }
  .note {
    font-size: 12px;
    margin-bottom: 1em;
    color: #555;
  }
  .filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 1em;
  }
  select, button {
    font-size: 14px;
    padding: 6px 10px;
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    white-space: nowrap;
  }
  th {
    background: #f0f0f0;
  }
  .pagination {
    margin: 1em 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
  }
</style>

<h2>介護事業所検索（高齢者）</h2>
<div class="note">このデータは高齢労働省のオープンデータ（2024年12月末時点）を使用しています</div>

<div class="filters">
  <select id="prefecture"><option value="">都道府県</option></select>
  <select id="city"><option value="">市区町村</option></select>
  <select id="service"><option value="">サービスの種類</option></select>
  <button id="search-btn">表示</button>
</div>

<div id="pagination" class="pagination"></div>

<table id="results-table">
  <thead>
    <tr>
      <th>No</th><th>事業所名</th><th>サービスの種類</th><th>電話番号</th><th>FAX番号</th>
      <th>Email</th><th>住所</th><th>事業所番号</th><th>法人名称</th><th>ホームページ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.js"></script>
<script>
  if (!window.__supabaseClient) {
    window.__supabaseClient = window.supabase.createClient(
      'https://udcrfwejohzmhfojnwha.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkY3Jmd2Vqb2h6bWhmb2pud2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5ODk1NzgsImV4cCI6MjA2MTU2NTU3OH0.dqy_L8iPlbUDoozkha4yjar4ADvinxGc0a6ygSuBLQI'
    );
  }
  const sb = window.__supabaseClient;
  let fullData = [], currentPage = 1, pageSize = 1000;

  const tablePrefixMap = {
    "北海道": "01_hokkaido", "青森県": "02_aomori"
  };

  document.addEventListener('DOMContentLoaded', () => {
    const prefs = Object.keys(tablePrefixMap);
    const prefSel = document.getElementById('prefecture');
    prefs.forEach(p => {
      const o = document.createElement('option');
      o.value = p; o.textContent = p;
      prefSel.appendChild(o);
    });
    prefSel.addEventListener('change', loadFilters);
    document.getElementById('search-btn').addEventListener('click', searchData);
    document.getElementById('pagination').addEventListener('click', handlePageClick);
  });

  async function loadFilters() {
    const pref = document.getElementById('prefecture').value;
    const table = tablePrefixMap[pref];
    const citySel = document.getElementById('city');
    const serviceSel = document.getElementById('service');
    citySel.innerHTML = '<option value="">市区町村</option>';
    serviceSel.innerHTML = '<option value="">サービスの種類</option>';
    const { data: cityData } = await sb.from(table).select('city').limit(10000);
    const { data: typeData } = await sb.from(table).select('service_type').limit(10000);
    const cities = [...new Set((cityData||[]).map(d => d.city).filter(Boolean))];
    const types = [...new Set((typeData||[]).map(d => d.service_type).filter(Boolean))];
    cities.sort().forEach(c => citySel.innerHTML += `<option value="${c}">${c}</option>`);
    types.sort().forEach(t => serviceSel.innerHTML += `<option value="${t}">${t}</option>`);
  }

  async function searchData() {
    const pref = document.getElementById('prefecture').value;
    const city = document.getElementById('city').value;
    const service = document.getElementById('service').value;
    const table = tablePrefixMap[pref];
    let query = sb.from(table).select('*').limit(10000);
    if (city) query = query.eq('city', city);
    if (service) query = query.eq('service_type', service);
    const { data, error } = await query;
    if (!error && data) {
      fullData = data; currentPage = 1;
      renderTable(); renderPagination();
    }
  }

  function renderTable() {
    const start = (currentPage - 1) * pageSize;
    const data = fullData.slice(start, start + pageSize);
    const tbody = document.querySelector('#results-table tbody');
    tbody.innerHTML = '';
    data.forEach((r, i) => {
      const row = `<tr>
        <td>${start + i + 1}</td><td>${r.office_name}</td><td>${r.service_type}</td>
        <td>${r.phone}</td><td>${r.fax}</td><td>${r.email}</td><td>${r.address}</td>
        <td>${r.office_number}</td><td>${r.organization_name}</td>
        <td>${r.url ? `<a href="${r.url}" target="_blank">リンク</a>` : ''}</td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  function renderPagination() {
    const total = Math.ceil(fullData.length / pageSize);
    const p = document.getElementById('pagination');
    if (total <= 1) return p.innerHTML = '';
    p.innerHTML = `
      <button data-nav="-1" ${currentPage === 1 ? 'disabled' : ''}>◁</button>
      ${currentPage} / ${total}ページ
      <button data-nav="1" ${currentPage === total ? 'disabled' : ''}>▷</button>
    `;
  }

  function handlePageClick(e) {
    if (e.target.tagName === 'BUTTON' && e.target.dataset.nav) {
      const offset = Number(e.target.dataset.nav);
      currentPage += offset;
      renderTable(); renderPagination();
    }
  }
</script>
