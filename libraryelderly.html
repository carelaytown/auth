<!-- CARELAYタウン｜全国介護事業所検索アプリ -->
<div id="libraryelderly-app" class="p-4 text-sm">
  <div class="mb-4">
    <label>都道府県：<select id="filter-prefecture" class="border p-1"></select></label>
    <label class="ml-4">市区町村：<select id="filter-city" class="border p-1"></select></label>
    <label class="ml-4">サービスの種類：<select id="filter-service" class="border p-1"></select></label>
  </div>
  <div id="table-container" class="overflow-x-auto border rounded">
    <table class="min-w-full text-left">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-2 py-1">No</th>
          <th class="px-2 py-1">事業所名</th>
          <th class="px-2 py-1">サービスの種類</th>
          <th class="px-2 py-1">電話番号</th>
          <th class="px-2 py-1">FAX</th>
          <th class="px-2 py-1">Email</th>
          <th class="px-2 py-1">住所</th>
          <th class="px-2 py-1">事業所番号</th>
          <th class="px-2 py-1">法人名称</th>
          <th class="px-2 py-1">ホームページ</th>
        </tr>
      </thead>
      <tbody id="result-body"></tbody>
    </table>
  </div>
  <div class="mt-4 flex justify-between">
    <button id="prev-page" class="px-2 py-1 bg-gray-200 rounded">前へ</button>
    <span id="page-info"></span>
    <button id="next-page" class="px-2 py-1 bg-gray-200 rounded">次へ</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

(() => {
  const supabase = createClient(
    'https://viihcgkjzzhkdiwdzdex.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM'
  );

  const limit = 100;
  let page = 0;
  let allData = [];

  const filters = {
    prefecture: '',
    city: '',
    service_type: ''
  };

  const $ = id => document.getElementById(id);

  async function fetchData() {
    const { data, error } = await supabase.from('facilities').select('*');
    if (error) return console.error(error);
    allData = data;
    populateFilters();
    render();
  }

  function populateFilters() {
    const prefs = [...new Set(allData.map(x => x.prefecture))];
    const services = [...new Set(allData.map(x => x.service_type))];
    $('filter-prefecture').innerHTML = '<option value="">すべて</option>' + prefs.map(p => `<option>${p}</option>`).join('');
    $('filter-service').innerHTML = '<option value="">すべて</option>' + services.map(s => `<option>${s}</option>`).join('');
    $('filter-prefecture').onchange = e => {
      filters.prefecture = e.target.value;
      filters.city = '';
      populateCities();
      page = 0;
      render();
    };
    $('filter-city').onchange = e => {
      filters.city = e.target.value;
      page = 0;
      render();
    };
    $('filter-service').onchange = e => {
      filters.service_type = e.target.value;
      page = 0;
      render();
    };
    populateCities();
  }

  function populateCities() {
    const cities = [...new Set(allData.filter(x => !filters.prefecture || x.prefecture === filters.prefecture).map(x => x.city))];
    $('filter-city').innerHTML = '<option value="">すべて</option>' + cities.map(c => `<option>${c}</option>`).join('');
  }

  function render() {
    const filtered = allData.filter(x =>
      (!filters.prefecture || x.prefecture === filters.prefecture) &&
      (!filters.city || x.city === filters.city) &&
      (!filters.service_type || x.service_type === filters.service_type)
    );
    const start = page * limit;
    const pageData = filtered.slice(start, start + limit);
    $('result-body').innerHTML = pageData.map((row, i) => `
      <tr>
        <td class="px-2 py-1">${start + i + 1}</td>
        <td class="px-2 py-1">${row.office_name || ''}</td>
        <td class="px-2 py-1">${row.service_type || ''}</td>
        <td class="px-2 py-1">${row.phone || ''}</td>
        <td class="px-2 py-1">${row.fax || ''}</td>
        <td class="px-2 py-1">${row.email || ''}</td>
        <td class="px-2 py-1">${row.address || ''}</td>
        <td class="px-2 py-1">${row.office_number || ''}</td>
        <td class="px-2 py-1">${row.organization_name || ''}</td>
        <td class="px-2 py-1">${row.url ? `<a href="${row.url}" target="_blank" class="text-blue-600 underline">リンク</a>` : ''}</td>
      </tr>
    `).join('');
    $('page-info').textContent = `ページ ${page + 1} / ${Math.ceil(filtered.length / limit)}`;
    $('prev-page').disabled = page === 0;
    $('next-page').disabled = start + limit >= filtered.length;
  }

  $('prev-page').onclick = () => { if (page > 0) { page--; render(); } };
  $('next-page').onclick = () => { page++; render(); };

  fetchData();
})();
</script>
