// 省略されたHTMLとCSS部分（保持）

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
(() => {
  const supabase = window.supabase.createClient(
    'https://viihcgkjzzhkdiwdzdex.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  );

  const PREFS = [
    ["01_hokkaido", "北海道"], ["02_aomori", "青森県"], ["03_iwate", "岩手県"], ["04_miyagi", "宮城県"],
    ["05_akita", "秋田県"], ["06_yamagata", "山形県"], ["07_fukushima", "福島県"],
    ["08_ibaraki", "茨城県"], ["09_tochigi", "栃木県"], ["10_gunma", "群馬県"],
    ["11_saitama", "埼玉県"], ["12_chiba", "千葉県"], ["13_tokyo", "東京都"], ["14_kanagawa", "神奈川県"],
    ["15_niigata", "新潟県"], ["16_toyama", "富山県"], ["17_ishikawa", "石川県"],
    ["18_fukui", "福井県"], ["19_yamanashi", "山梨県"], ["20_nagano", "長野県"],
    ["21_gifu", "岐阜県"], ["22_shizuoka", "静岡県"], ["23_aichi", "愛知県"],
    ["24_mie", "三重県"], ["25_shiga", "滋賀県"], ["26_kyoto", "京都府"],
    ["27_osaka", "大阪府"], ["28_hyogo", "兵庫県"], ["29_nara", "奈良県"], ["30_wakayama", "和歌山県"],
    ["31_tottori", "鳥取県"], ["32_shimane", "島根県"], ["33_okayama", "岡山県"],
    ["34_hiroshima", "広島県"], ["35_yamaguchi", "山口県"], ["36_tokushima", "徳島県"],
    ["37_kagawa", "香川県"], ["38_ehime", "愛媛県"], ["39_kochi", "高知県"],
    ["40_fukuoka", "福岡県"], ["41_saga", "佐賀県"], ["42_nagasaki", "長崎県"],
    ["43_kumamoto", "熊本県"], ["44_oita", "大分県"], ["45_miyazaki", "宮崎県"],
    ["46_kagoshima", "鹿児島県"], ["47_okinawa", "沖縄県"]
  ];

  let allData = [], filteredData = [], currentPage = 1;
  const pageSize = 100;

  const prefSelect = document.getElementById("prefSelect");
  const citySelect = document.getElementById("citySelect");
  const serviceSelect = document.getElementById("serviceSelect");
  const searchBtn = document.getElementById("searchBtn");
  const resultBody = document.getElementById("resultBody");
  const countDisplay = document.getElementById("count");
  const pagination = document.getElementById("pagination");

  PREFS.forEach(([value, label]) => {
    const op = document.createElement("option");
    op.value = value;
    op.textContent = label;
    prefSelect.appendChild(op);
  });

  prefSelect.addEventListener("change", async () => {
    citySelect.innerHTML = '<option value="">すべて</option>';
    serviceSelect.innerHTML = '<option value="">すべて</option>';
    resultBody.innerHTML = "";
    countDisplay.textContent = "対象件数：0件";
    pagination.textContent = "";
    allData = [];
    currentPage = 1;

    const table = prefSelect.value;
    let from = 0, to = 999;
    while (true) {
      const { data, error } = await supabase.from(table).select("*").range(from, to);
      if (error || !data.length) break;
      allData = allData.concat(data);
      if (data.length < 1000) break;
      from += 1000; to += 1000;
    }

    const cities = [...new Set(allData.map(d => d.city).filter(Boolean))].sort();
    const services = [...new Set(allData.map(d => d.service_type).filter(Boolean))].sort();

    cities.forEach(c => {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      citySelect.appendChild(o);
    });
    services.forEach(s => {
      const o = document.createElement("option");
      o.value = s;
      o.textContent = s;
      serviceSelect.appendChild(o);
    });
  });

  searchBtn.addEventListener("click", () => {
    const city = citySelect.value;
    const service = serviceSelect.value;
    filteredData = allData.filter(d =>
      (!city || d.city === city) && (!service || d.service_type === service)
    );
    currentPage = 1;
    renderPage();
  });

  function renderPage() {
    resultBody.innerHTML = "";
    const total = filteredData.length;
    const pageCount = Math.ceil(total / pageSize);
    const start = (currentPage - 1) * pageSize;
    const pageData = filteredData.slice(start, start + pageSize);

    countDisplay.textContent = `対象件数：${total}件`;
    pagination.innerHTML = `<span id="prevBtn">◁</span>${currentPage}/${pageCount}<span id="nextBtn">▷</span>`;

    pageData.forEach(d => {
      const tr = document.createElement("tr");
      ["office_name","service_type","phone","fax","email","address","office_number","organization_name","url"].forEach(key => {
        const td = document.createElement("td");
        td.textContent = d[key] || "";
        tr.appendChild(td);
      });
      resultBody.appendChild(tr);
    });

    document.getElementById("prevBtn").onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    };
    document.getElementById("nextBtn").onclick = () => {
      if (currentPage < pageCount) {
        currentPage++;
        renderPage();
      }
    };
  }
})();
</script>
