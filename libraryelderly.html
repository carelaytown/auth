<style>
#libraryelderly-app {
  font-family: sans-serif;
  background-color: #fff;
  padding: 1rem;
}
#libraryelderly-app select, #libraryelderly-app button {
  font-size: 0.9rem;
  padding: 0.4rem 0.6rem;
  margin-right: 0.5rem;
}
#libraryelderly-app table {
  border-collapse: collapse;
  width: 100%;
  font-size: 0.9rem;
  margin-top: 1rem;
}
#libraryelderly-app th, #libraryelderly-app td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: left;
}
#libraryelderly-app th {
  background-color: #f0f0f0;
}
#libraryelderly-app td:nth-child(1) { width: 40px; text-align: center; }
#libraryelderly-app td:nth-child(2) { min-width: 160px; max-width: 200px; }
#libraryelderly-app td:nth-child(3) { min-width: 120px; max-width: 140px; }
#libraryelderly-app td:nth-child(4),
#libraryelderly-app td:nth-child(5),
#libraryelderly-app td:nth-child(6) { min-width: 110px; max-width: 130px; word-break: break-word; }
#libraryelderly-app td:nth-child(7) { min-width: 200px; max-width: 260px; }
#libraryelderly-app td:nth-child(8) { min-width: 130px; max-width: 160px; }
#libraryelderly-app td:nth-child(9) { min-width: 140px; max-width: 180px; }
#libraryelderly-app td:nth-child(10) { min-width: 80px; max-width: 100px; word-break: break-all; }
#libraryelderly-app .pagination button {
  margin: 0 0.25rem;
  padding: 0.3rem 0.6rem;
  font-size: 0.85rem;
}
</style>

<div id="libraryelderly-app">
  <h2>介護事業所検索（高齢者）</h2>
  <p>このデータは高齢労働省のオープンデータ（2024年12月末時点）を使用しています</p>
  <div class="filter-group">
    <select id="prefSelect"><option value="">都道府県</option></select>
    <select id="citySelect"><option value="">市区町村</option></select>
    <select id="serviceSelect"><option value="">サービスの種別</option></select>
    <button id="searchBtn">表示</button>
  </div>
  <div id="result_count"></div>
  <div id="tableContainer"></div>
  <div id="pagination" class="pagination"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.js"></script>

<script>
(() => {
  const supabase = window.supabaseClient || window.supabase.createClient(
    "https://viihcgkjzzhkdiwdzdex.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  );

  let fullData = [];
  let currentPage = 1;
  const pageSize = 1000;

  async function fetchData() {
    const prefecture = document.getElementById("prefSelect").value;
    const city = document.getElementById("citySelect").value;
    const service = document.getElementById("serviceSelect").value;
    if (!prefecture) return;

    let query = supabase.from(prefecture).select("*");

    if (city) query = query.eq("city", city);
    if (service) query = query.eq("service_type", service);

    fullData = [];
    let from = 0, to = pageSize - 1;

    while (true) {
      const { data, error } = await query.range(from, to);
      if (error) {
        console.error("Fetch error:", error);
        break;
      }
      if (!data || data.length === 0) break;
      fullData.push(...data);
      if (data.length < pageSize) break;
      from += pageSize;
      to += pageSize;
    }

    currentPage = 1;
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById("resultBody");
    const total = fullData.length;
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = fullData.slice(start, end);

    tbody.innerHTML = pageData.map((row, index) => `
      <tr>
        <td>${start + index + 1}</td>
        <td>${row.office_name || ""}</td>
        <td>${row.service_type || ""}</td>
        <td>${row.phone || ""}</td>
        <td>${row.fax || ""}</td>
        <td>${row.email || ""}</td>
        <td>${row.address || ""}</td>
        <td>${row.office_number || ""}</td>
        <td>${row.organization_name || ""}</td>
        <td>${row.url ? `<a href="\${row.url}" target="_blank">リンク</a>` : ""}</td>
      </tr>
    `).join("");

    document.getElementById("resultCount").textContent = `該当件数：${total}件`;
    renderPagination(total);
  }

  function renderPagination(total) {
    const pages = Math.ceil(total / pageSize);
    const container = document.getElementById("pagination");
    container.innerHTML = "";

    if (pages <= 1) return;

    for (let i = 1; i <= pages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = i === currentPage ? "active" : "";
      btn.onclick = () => { currentPage = i; renderTable(); };
      container.appendChild(btn);
    }
  }

  window.fetchData = fetchData;
})();
</script>
