<div id="app-search">
  <h1>介護事業所検索（高齢者）</h1>
  <div class="note">このデータは高齢労働省のオープンデータ（2024年12月末時点）を使用しています。</div>

  <div>
    <select id="prefSelect"></select>
    <select id="citySelect"></select>
    <select id="serviceSelect"></select>
    <button id="searchBtn">表示</button>
  </div>

  <div class="meta">
    <div id="count">対象件数：0件</div>
    <div class="pagination" id="pagination"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>事業所名</th>
        <th>サービスの種類</th>
        <th>電話番号</th>
        <th>FAX番号</th>
        <th>Email</th>
        <th>住所</th>
        <th>事業所番号</th>
        <th>法人名称</th>
        <th>ホームページ</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>
</div>

<style>
#app-search {
  font-family: "Segoe UI", sans-serif;
  max-width: 1200px;
  margin: auto;
  padding: 1em;
}
#app-search h1 {
  font-size: 1.5em;
  margin-bottom: 0.2em;
}
#app-search .note {
  font-size: 0.9em;
  color: #666;
  margin-bottom: 1em;
}
#app-search select, #app-search button {
  padding: 0.4em;
  margin-right: 0.5em;
  font-size: 0.9em;
}
#app-search table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 1em;
}
#app-search th, #app-search td {
  border: 1px solid #ccc;
  padding: 0.4em 0.6em;
  text-align: left;
  max-width: 200px;
  overflow-wrap: break-word;
}
#app-search th {
  background: #f0f0f0;
}
#app-search .meta {
  margin-top: 1em;
  display: flex;
  justify-content: space-between;
}
#app-search .pagination {
  font-size: 0.9em;
  user-select: none;
}
#app-search .pagination span {
  cursor: pointer;
  margin: 0 0.5em;
}
</style>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(
  'https://viihcgkjzzhkdiwdzdex.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM'
);

const PREFS = ["01_hokkaido","02_aomori","03_iwate","04_miyagi","05_akita","06_yamagata","07_fukushima","08_ibaraki","09_tochigi","10_gunma","11_saitama","12_chiba","13_tokyo","14_kanagawa","15_niigata","16_toyama","17_ishikawa","18_fukui","19_yamanashi","20_nagano","21_gifu","22_shizuoka","23_aichi","24_mie","25_shiga","26_kyoto","27_osaka","28_hyogo","29_nara","30_wakayama","31_tottori","32_shimane","33_okayama","34_hiroshima","35_yamaguchi","36_tokushima","37_kagawa","38_ehime","39_kochi","40_fukuoka","41_saga","42_nagasaki","43_kumamoto","44_oita","45_miyazaki","46_kagoshima","47_okinawa"];

let allData = [];
let filteredData = [];
let currentPage = 1;
const pageSize = 100;

const prefSelect = document.getElementById("prefSelect");
const citySelect = document.getElementById("citySelect");
const serviceSelect = document.getElementById("serviceSelect");
const searchBtn = document.getElementById("searchBtn");
const resultBody = document.getElementById("resultBody");
const countDisplay = document.getElementById("count");
const pagination = document.getElementById("pagination");

PREFS.forEach(p => {
  const op = document.createElement("option");
  op.value = p;
  op.textContent = p.replace(/\d+_/, "");
  prefSelect.appendChild(op);
});

prefSelect.addEventListener("change", async () => {
  citySelect.innerHTML = "";
  serviceSelect.innerHTML = "";
  resultBody.innerHTML = "";
  countDisplay.textContent = "対象件数：0件";
  pagination.textContent = "";
  allData = [];
  currentPage = 1;

  const table = prefSelect.value;
  let from = 0, to = 999;
  while (true) {
    const { data, error } = await supabase.from(table).select("*").range(from, to);
    if (error || !data.length) break;
    allData = allData.concat(data);
    if (data.length < 1000) break;
    from += 1000; to += 1000;
  }

  const cities = [...new Set(allData.map(d => d.city).filter(Boolean))].sort();
  const services = [...new Set(allData.map(d => d.service_type).filter(Boolean))].sort();

  cities.forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    citySelect.appendChild(o);
  });
  services.forEach(s => {
    const o = document.createElement("option");
    o.value = s;
    o.textContent = s;
    serviceSelect.appendChild(o);
  });
});

searchBtn.addEventListener("click", () => {
  const city = citySelect.value;
  const service = serviceSelect.value;
  filteredData = allData.filter(d => d.city === city && d.service_type === service);
  currentPage = 1;
  renderPage();
});

function renderPage() {
  resultBody.innerHTML = "";
  const total = filteredData.length;
  const pageCount = Math.ceil(total / pageSize);
  const start = (currentPage - 1) * pageSize;
  const pageData = filteredData.slice(start, start + pageSize);

  countDisplay.textContent = `対象件数：${total}件`;
  pagination.innerHTML = `<span id="prevBtn">◁</span>${currentPage}/${pageCount}<span id="nextBtn">▷</span>`;

  pageData.forEach(d => {
    const tr = document.createElement("tr");
    ["office_name","service_type","phone","fax","email","address","office_number","organization_name","url"].forEach(key => {
      const td = document.createElement("td");
      td.textContent = d[key] || "";
      tr.appendChild(td);
    });
    resultBody.appendChild(tr);
  });

  document.getElementById("prevBtn").onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage();
    }
  };
  document.getElementById("nextBtn").onclick = () => {
    if (currentPage < pageCount) {
      currentPage++;
      renderPage();
    }
  };
}
</script>
