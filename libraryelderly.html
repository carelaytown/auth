<!-- CARELAYタウン対応 完全版（HTMLタグ省略） -->

<!-- CSS -->
<style>
  #filter-area {
    background: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 24px;
  }

  select, button {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    min-width: 160px;
  }

  button {
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }

  #result-area {
    background: white;
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    font-size: 13px;
    word-break: break-word;
  }

  th {
    background: #f5f5f5;
  }

  #pagination {
    margin-top: 12px;
    display: flex;
    justify-content: center;
    gap: 8px;
  }

  .page-btn {
    padding: 6px 12px;
    border: 1px solid #aaa;
    background: #fff;
    cursor: pointer;
  }
</style>

<!-- フィルターと結果表示 -->
<div id="filter-area">
  <select id="prefecture">
    <option value="">都道府県を選択</option>
    <option value="01_hokkaido">北海道</option>
    <option value="02_aomori">青森県</option>
    <!-- ...他都道府県もここに追加可 -->
  </select>
  <select id="city">
    <option value="">市区町村を選択</option>
  </select>
  <select id="service">
    <option value="">サービスの種類を選択</option>
  </select>
  <button id="search-btn">表示</button>
</div>

<div id="result-area">
  <div id="result-count"></div>
  <table id="result-table">
    <thead>
      <tr>
        <th>通し番号</th>
        <th>事業所名</th>
        <th>サービスの種類</th>
        <th>電話番号</th>
        <th>FAX番号</th>
        <th>Email</th>
        <th>住所</th>
        <th>事業所番号</th>
        <th>法人名称</th>
        <th>ホームページ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="pagination"></div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.js"></script>
<script>
  const supabase = supabase.createClient(
    'https://viihcgkjzzhkdiwdzdex.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM'
  );

  let currentData = [];
  let currentPage = 1;
  const pageSize = 100;

  document.getElementById('prefecture').addEventListener('change', async e => {
    const table = e.target.value;
    if (!table) return;

    const { data, error } = await supabase.from(table).select('city,service_type').limit(10000);
    if (error) return console.error(error);

    const cities = [...new Set(data.map(d => d.city))].sort();
    const services = [...new Set(data.map(d => d.service_type))].sort();

    const citySelect = document.getElementById('city');
    citySelect.innerHTML = '<option value="">市区町村を選択</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');

    const serviceSelect = document.getElementById('service');
    serviceSelect.innerHTML = '<option value="">サービスの種類を選択</option>' + services.map(s => `<option value="${s}">${s}</option>`).join('');
  });

  document.getElementById('search-btn').addEventListener('click', async () => {
    const table = document.getElementById('prefecture').value;
    const city = document.getElementById('city').value;
    const service = document.getElementById('service').value;
    if (!table) return;

    let query = supabase.from(table).select('*').limit(10000);
    if (city) query = query.eq('city', city);
    if (service) query = query.eq('service_type', service);

    const { data, error } = await query;
    if (error) return console.error(error);

    currentData = data;
    currentPage = 1;
    renderTable();
  });

  function renderTable() {
    const tbody = document.querySelector('#result-table tbody');
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pagedData = currentData.slice(start, end);

    tbody.innerHTML = pagedData.map((row, i) => `
      <tr>
        <td>${start + i + 1}</td>
        <td>${row.office_name || ''}</td>
        <td>${row.service_type || ''}</td>
        <td>${row.phone || ''}</td>
        <td>${row.fax || ''}</td>
        <td>${row.email || ''}</td>
        <td>${row.address || ''}</td>
        <td>${row.office_number || ''}</td>
        <td>${row.organization_name || ''}</td>
        <td>${row.url ? `<a href="${row.url}" target="_blank">リンク</a>` : ''}</td>
      </tr>
    `).join('');

    document.getElementById('result-count').textContent = `該当件数：${currentData.length}件`;
    renderPagination();
  }

  function renderPagination() {
    const container = document.getElementById('pagination');
    const totalPages = Math.ceil(currentData.length / pageSize);
    container.innerHTML = '';

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.className = 'page-btn';
      btn.textContent = i;
      if (i === currentPage) btn.style.background = '#ccc';
      btn.addEventListener('click', () => {
        currentPage = i;
        renderTable();
      });
      container.appendChild(btn);
    }
  }
</script>
