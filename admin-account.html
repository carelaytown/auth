<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アカウント管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background: #f7faff;
      padding: 30px;
    }
    h2 {
      margin-bottom: 20px;
      color: #2a6ebb;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .toolbar button {
      padding: 8px 16px;
      margin-right: 5px;
      border: none;
      background-color: #2a6ebb;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .toolbar button:hover {
      background-color: #1f5aa0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #2a6ebb;
      color: white;
    }
  </style>
</head>
<body>

<h2>アカウント管理</h2>

<div class="toolbar">
  <div>
    <button onclick="applyFilter('all')">すべて</button>
    <button onclick="applyFilter('approved')">承認済</button>
    <button onclick="applyFilter('pending')">未承認</button>
  </div>
  <div>
    <button onclick="approveSelected()">承認</button>
    <button onclick="rejectSelected()">解除</button>
    <button onclick="deleteSelected()">削除</button>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
      <th>事業所名</th>
      <th>メールアドレス</th>
      <th>状態</th>
      <th>管理者</th>
    </tr>
  </thead>
  <tbody id="accountTableBody"></tbody>
</table>

<script>
const supabaseUrl = "https://viihcgkjzzhkdiwdzdex.supabase.co"; // ←ここを修正
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM"; // ←ここも修正

let allAccounts = [];

async function loadAccounts() {
  const res = await fetch(`${supabaseUrl}/rest/v1/applications?select=*`, {
    headers: {
      apikey: supabaseKey,
      Authorization: `Bearer ${supabaseKey}`
    }
  });
  const data = await res.json();
  allAccounts = data;
  renderAccounts("all");
}

function renderAccounts(filter) {
  const tbody = document.getElementById("accountTableBody");
  tbody.innerHTML = "";
  const filtered = allAccounts.filter(acc => {
    if (filter === "approved") return acc.status === "approved";
    if (filter === "pending") return acc.status === "pending";
    return true;
  });

  filtered.forEach(acc => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${acc.id}"></td>
      <td>${acc.org_name}</td>
      <td>${acc.email}</td>
      <td>${acc.status}</td>
      <td>${acc.is_admin ? "✅" : ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

function applyFilter(filter) {
  renderAccounts(filter);
}

function toggleAll(source) {
  const checkboxes = document.querySelectorAll("#accountTableBody input[type='checkbox']");
  checkboxes.forEach(cb => cb.checked = source.checked);
}

async function approveSelected() {
  await updateStatus("approved");
}

async function rejectSelected() {
  await updateStatus("pending");
}

async function deleteSelected() {
  const selected = getSelectedIds();
  for (const id of selected) {
    await fetch(`${supabaseUrl}/rest/v1/applications?id=eq.${id}`, {
      method: "DELETE",
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`
      }
    });
  }
  await loadAccounts();
}

async function updateStatus(status) {
  const selected = getSelectedIds();
  for (const id of selected) {
    await fetch(`${supabaseUrl}/rest/v1/applications?id=eq.${id}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`
      },
      body: JSON.stringify({ status })
    });
  }
  await loadAccounts();
}

function getSelectedIds() {
  const checkboxes = document.querySelectorAll("#accountTableBody input[type='checkbox']:checked");
  return [...checkboxes].map(cb => cb.dataset.id);
}

window.onload = loadAccounts;
</script>

</body>
</html>
