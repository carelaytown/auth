<div id="mainSection">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
      <button onclick="applyFilter('all')">すべて</button>
      <button onclick="applyFilter('approved')">承認済</button>
      <button onclick="applyFilter('pending')">未承認</button>
    </div>
    <div>
      <button onclick="approveSelected()">承認</button>
      <button onclick="rejectSelected()">解除</button>
      <button onclick="deleteSelected()">削除</button>
    </div>
  </div>

  <table border="1" cellpadding="6" cellspacing="0" style="width:100%; background:white; border-collapse: collapse;">
    <thead>
      <tr style="background-color:#2a6ebb; color:white;">
        <th style="width: 30px;"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
        <th>事業所名</th>
        <th>メールアドレス</th>
        <th>状態</th>
        <th>管理者</th>
      </tr>
    </thead>
    <tbody id="accountTableBody"></tbody>
  </table>
</div>

<script>
const supabaseUrl = "https://viihcgkjzzhkdiwdzdex.supabase.co";
const supabaseKey = "eyJhbGciOiJI..."; // 適切に省略

async function loadAccountList() {
  const res = await fetch(`${supabaseUrl}/rest/v1/applications`, {
    headers: {
      apikey: supabaseKey,
      Authorization: `Bearer ${supabaseKey}`
    }
  });
  const data = await res.json();
  window.accountData = data;
  renderAccounts("all");
}

function renderAccounts(filter) {
  const tbody = document.getElementById("accountTableBody");
  tbody.innerHTML = "";
  const filtered = window.accountData.filter(row => {
    if (filter === "approved") return row.status === "approved";
    if (filter === "pending") return row.status === "pending";
    return true;
  });

  filtered.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${row.id}"></td>
      <td>${row.org_name}</td>
      <td>${row.email}</td>
      <td>${row.status}</td>
      <td>${row.is_admin ? "✅" : ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

function applyFilter(filter) {
  renderAccounts(filter);
}

function toggleAll(source) {
  const checkboxes = document.querySelectorAll("#accountTableBody input[type='checkbox']");
  checkboxes.forEach(cb => cb.checked = source.checked);
}

async function approveSelected() {
  await updateSelected("approved");
}

async function rejectSelected() {
  await updateSelected("pending");
}

async function deleteSelected() {
  const selected = [...document.querySelectorAll("#accountTableBody input[type='checkbox']:checked")];
  for (const cb of selected) {
    const id = cb.dataset.id;
    await fetch(`${supabaseUrl}/rest/v1/applications?id=eq.${id}`, {
      method: "DELETE",
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`
      }
    });
  }
  await loadAccountList();
}

async function updateSelected(status) {
  const selected = [...document.querySelectorAll("#accountTableBody input[type='checkbox']:checked")];
  for (const cb of selected) {
    const id = cb.dataset.id;
    await fetch(`${supabaseUrl}/rest/v1/applications?id=eq.${id}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`
      },
      body: JSON.stringify({ status })
    });
  }
  await loadAccountList();
}
</script>
