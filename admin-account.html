<style>
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #f0f0f0;
  }
  .filter-btns button {
    margin-right: 10px;
    padding: 6px 12px;
    background-color: #e0e0e0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .filter-btns button.active {
    background-color: #1b355d;
    color: white;
  }
</style>

<div>
  <h2>👤 アカウント管理</h2>
  <div class="filter-btns">
    <button id="f-all" class="active" onclick="loadAccounts('all')">全て</button>
    <button id="f-pending" onclick="loadAccounts('pending')">未承認</button>
    <button id="f-approved" onclick="loadAccounts('approved')">承認済</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>事業所名</th>
        <th>メールアドレス</th>
        <th>状態</th>
        <th>管理者</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="accountTable">
      <tr><td colspan="5">読み込み中...</td></tr>
    </tbody>
  </table>
</div>

<script>
  const SUPABASE_URL = 'https://viihcgkjzzhkdiwdzdex.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadAccounts(filter = 'all') {
    document.querySelectorAll(".filter-btns button").forEach(b => b.classList.remove("active"));
    document.getElementById(`f-${filter}`).classList.add("active");

    let query = supabase.from("applications").select("*").order("created_at", { ascending: false });
    if (filter === "pending") query = query.eq("status", "pending");
    if (filter === "approved") query = query.eq("status", "approved");

    const { data, error } = await query;
    const tbody = document.getElementById("accountTable");
    tbody.innerHTML = "";

    if (error || !data) {
      tbody.innerHTML = `<tr><td colspan="5">読み込みエラー</td></tr>`;
      return;
    }

    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5">該当なし</td></tr>`;
      return;
    }

    for (const row of data) {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${row.org_name || "-"}</td>
        <td>${row.email}</td>
        <td>${row.status}</td>
        <td>${row.is_admin ? "✅" : ""}</td>
        <td>
          ${row.status === "approved"
            ? `<button onclick="updateStatus('${row.email}', 'pending')">解除</button>`
            : `<button onclick="updateStatus('${row.email}', 'approved')">承認</button>`}
        </td>
      `;

      tbody.appendChild(tr);
    }
  }

  async function updateStatus(email, newStatus) {
    const { error } = await supabase
      .from("applications")
      .update({ status: newStatus })
      .eq("email", email);

    if (error) {
      alert("更新に失敗しました。");
    } else {
      loadAccounts(document.querySelector(".filter-btns button.active").id.replace("f-", ""));
    }
  }

  loadAccounts("all");
</script>
