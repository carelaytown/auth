<!DOCTYPE html>
 <html lang="ja">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>アカウント管理</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <style>
   /* (CSSは変更なし) */
  </style>
 </head>
 <body>
  <div class="account-container">
   <h2>アカウント管理</h2>
   <div class="action-group">
    <button onclick="updateStatus('approved')">✅ 承認</button>
    <button onclick="updateStatus('pending')">⛔ 解除</button>
    <button onclick="deleteSelected()">🗑️ 削除</button>
   </div>
   <div class="filter-group">
    <label><input type="radio" name="filter" value="all" checked onchange="filterAccounts()"> 全て</label>
    <label><input type="radio" name="filter" value="pending" onchange="filterAccounts()"> 未承認</label>
    <label><input type="radio" name="filter" value="approved" onchange="filterAccounts()"> 承認済み</label>
   </div>
   <table id="account-table">
    <thead>
     <tr>
      <th><input type="checkbox" onclick="toggleAll(this)"></th>
      <th>事業所名</th>
      <th>メールアドレス</th>
      <th>管理者</th>
      <th>状態</th>
     </tr>
    </thead>
    <tbody>
     </tbody>
   </table>
  </div>
  <script type="module">
   import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
   const supabase = createClient(  // 再度初期化
    "https://viihcgkjzzhkdiwdzdex.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpaWhjZ2tqenpoa2Rpd2R6ZGV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzE4MDksImV4cCI6MjA2MTY0NzgwOX0.3SMdVvDEp103fwnLvgtsec7J7ly4A_SEJlrEb0BZ9YM"
   );
   let allData = [];
   async function fetchAccounts() {
    const { data, error } = await supabase
     .from("applications")
     .select("*");
    if (error) {
     alert("読み込みエラー: " + error.message);
     return;
    }
    allData = data;
    renderTable(data);
   }
   function renderTable(data) {
    const tbody = document.querySelector("#account-table tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
     const tr = document.createElement("tr");
     tr.innerHTML = `
       <td><input type="checkbox" data-email="${row.email}"></td>
       <td>${row.org_name || ""}</td>
       <td>${row.email}</td>
       <td>${row.as_admin ? "管理者" : ""}</td>
       <td class="${row.status === "approved" ? "status-approved" : "status-pending"}">${row.status}</td>
     `;
     tbody.appendChild(tr);
    });
   }
   function toggleAll(master) {
    document.querySelectorAll("#account-table tbody input[type='checkbox']").forEach(cb => cb.checked = master.checked);
   }
   function filterAccounts() {
    const filter = document.querySelector("input[name='filter']:checked").value;
    if (filter === "all") {
     renderTable(allData);
    } else {
     renderTable(allData.filter(row => row.status === filter));
    }
   }
   async function updateStatus(newStatus) {
    const selected = [...document.querySelectorAll("#account-table tbody input:checked")].map(cb => cb.dataset.email);
    if (selected.length === 0) return alert("対象が選択されていません");
    const { error } = await supabase
     .from("applications")
     .update({ status: newStatus })
     .in("email", selected);
    if (error) {
     alert("更新エラー: " + error.message);
    } else {
     fetchAccounts();
    }
   }
   async function deleteSelected() {
    const selected = [...document.querySelectorAll("#account-table tbody input:checked")].map(cb => cb.dataset.email);
    if (selected.length === 0) return alert("対象が選択されていません");
    const { error } = await supabase
     .from("applications")
     .delete()
     .in("email", selected);
    if (error) {
     alert("削除エラー: " + error.message);
    } else {
     fetchAccounts();
    }
   }
   fetchAccounts();
  </script>
 </body>
 </html>
