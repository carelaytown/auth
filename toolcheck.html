<style>
    #toolcheck-app * {
        box-sizing: border-box;
    }

    #toolcheck-app {
        font-family: sans-serif;
        padding: 1em;
        max-width: 1200px;
        margin: auto;
    }

    #toolcheck-app .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1em;
    }

    #toolcheck-app .sheet-title {
        font-size: 1.5em;
        font-weight: bold;
        flex: 1;
    }

    #toolcheck-app .sheet-title[contenteditable] {
        background: #eef;
        padding: 4px;
        border-radius: 4px;
    }

    #toolcheck-app .sheet-controls {
        display: flex;
        gap: 8px;
    }

    #toolcheck-app select,
    #toolcheck-app button {
        padding: 4px 8px;
        font-size: 14px;
    }

    #toolcheck-app .cs-container {
        display: flex;
        flex-direction: column;
        gap: 1em;
    }

    #toolcheck-app .cs-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    #toolcheck-app .cs-table th,
    #toolcheck-app .cs-table td {
        border: 1px solid #ccc;
        padding: 4px;
        font-size: 12px;
        text-align: center;
        word-wrap: break-word;
    }

    #toolcheck-app .cs-table th {
        background-color: #f0f0f0;
    }

    #toolcheck-app .cs-status-未対応 {
        background-color: #fff3cd;
    }

    #toolcheck-app .cs-status-対応中 {
        background-color: #d1ecf1;
    }

    #toolcheck-app .cs-status-完了 {
        background-color: #d4edda;
    }

    #toolcheck-app .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #toolcheck-app .modal-content {
        background: white;
        padding: 1em;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
    }

    #toolcheck-app .modal-content label {
        font-weight: bold;
        display: block;
        margin-top: 0.5em;
    }

    #toolcheck-app .modal-content input,
    #toolcheck-app .modal-content textarea,
    #toolcheck-app .modal-content select {
        width: 100%;
        margin-top: 4px;
        padding: 6px;
    }

    #toolcheck-app .modal-buttons {
        margin-top: 1em;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    #toolcheck-app .cs-btn {
        padding: 4px 8px;
        font-size: 12px;
    }

    #toolcheck-app .history-list span {
        display: inline-block;
        background: #eee;
        margin: 2px;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
    }

    #toolcheck-app .history-list span button {
        margin-left: 4px;
        background: transparent;
        border: none;
        cursor: pointer;
        color: red;
    }

    #toolcheck-app .sheet-selector {
        padding: 6px 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: white;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 250px;
    }

    #toolcheck-app .sheet-combo {
        padding: 6px 30px 6px 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: white;
        width: 250px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M0,0 L6,8 L12,0 Z' fill='%23666'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px 8px;
    }
</style>

<div id="toolcheck-app">
    <div class="header-bar">
        <div id="sheet-title" class="sheet-title" contenteditable="true">新しいチェック表</div>
        <div class="sheet-controls">
            <input type="text" id="sheet-selector" list="sheet-options" class="sheet-combo">
<datalist id="sheet-options"></datalist>
            <button id="sheet-new">＋新規</button>
            <button id="sheet-delete">🗑削除</button>
            <button id="add-entry">予定の追加</button>
            <button id="export-csv">CSV出力</button>
        </div>
    </div>

    <div class="cs-container">
        <div class="filter-bar" style="margin-bottom: 1em;">
            担当者：
            <select id="filter-person">
                <option value="">すべて</option>
            </select>
            項目：
            <select id="filter-type">
                <option value="">すべて</option>
            </select>
            状態：
            <select id="filter-status">
                <option value="">すべて</option>
                <option value="未対応">未対応</option>
                <option value="対応中">対応中</option>
                <option value="完了">完了</option>
            </select>
        </div>
        <table class="cs-table" id="cs-table">
            <thead>
                <tr>
                    <th onclick="sortBy('date')" data-label="日付">日付 ⇅</th>
                    <th onclick="sortBy('person')" data-label="担当者">担当者 ⇅</th>
                    <th onclick="sortBy('type')" data-label="項目">項目 ⇅</th>
                    <th onclick="sortBy('content')" data-label="内容">内容 ⇅</th>
                    <th onclick="sortBy('deadline')" data-label="締切">締切 ⇅</th>
                    <th onclick="sortBy('status')" data-label="状態">状態 ⇅</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="modal" id="entry-modal">
        <div class="modal-content">
            <label>日付<input type="date" id="entry-date"></label>
            <label>担当者<input type="text" id="entry-person" list="person-suggestions"></label>
            <datalist id="person-suggestions"></datalist>
            <div id="person-history" class="history-list"></div>
            <label>項目<input type="text" id="entry-type" list="type-suggestions"></label>
            <datalist id="type-suggestions"></datalist>
            <div id="type-history" class="history-list"></div>
            </label>
            <label>内容<textarea id="entry-content"></textarea></label>
            <label>締切<input type="date" id="entry-deadline"></label>
            <label>状態
                <select id="entry-status">
                    <option>未対応</option>
                    <option>対応中</option>
                    <option>完了</option>
                </select>
            </label>
            <div class="modal-buttons">
                <button id="entry-cancel">閉じる</button>
                <button id="entry-save">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="new-sheet-modal">
        <div class="modal-content">
            <label>新しいチェック表の名前<input type="text" id="new-sheet-name"></label>
            <div class="modal-buttons">
                <button id="new-sheet-cancel">キャンセル</button>
                <button id="new-sheet-create">作成</button>
            </div>
        </div>
    </div>

    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <p id="confirm-message">削除してもよろしいですか？</p>
            <div class="modal-buttons">
                <button id="confirm-cancel">キャンセル</button>
                <button id="confirm-ok">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        // === 共通関数定義 ===
        const getSavedList = (key) => JSON.parse(localStorage.getItem(key) || "[]");
        const saveToList = (key, value) => {
            if (!value) return;
            const list = getSavedList(key);
            if (!list.includes(value)) {
                list.push(value);
                localStorage.setItem(key, JSON.stringify(list));
            }
        };
        const removeFromList = (key, value) => {
            const list = getSavedList(key).filter(v => v !== value);
            localStorage.setItem(key, JSON.stringify(list));
        };
        const renderSuggestions = (key, datalistElem) => {
            if (!datalistElem) return;
            datalistElem.innerHTML = "";
            getSavedList(key).forEach(v => {
                const opt = document.createElement("option");
                opt.value = v;
                datalistElem.appendChild(opt);
            });
        };
        const renderHistory = (key, containerId, suggestionId, inputId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";
            getSavedList(key).forEach(val => {
                const span = document.createElement("span");
                span.textContent = val;
                span.onclick = () => {
                    const input = document.getElementById(inputId);
                    if (input) input.value = val;
                };
                const btn = document.createElement("button");
                btn.textContent = "×";
                btn.onclick = (e) => {
                    e.stopPropagation();
                    removeFromList(key, val);
                    renderHistory(key, containerId, suggestionId, inputId);
                    renderSuggestions(key, document.getElementById(suggestionId));
                };
                span.appendChild(btn);
                container.appendChild(span);
            });
        };

        // === グローバル変数 ===
        const root = document.getElementById("toolcheck-app");
        const modal = root.querySelector("#entry-modal");
        const tableBody = root.querySelector("#cs-table tbody");
        const selector = root.querySelector("#sheet-selector");
        const titleElem = root.querySelector("#sheet-title");
        const newSheetModal = root.querySelector("#new-sheet-modal");
        const newSheetNameInput = root.querySelector("#new-sheet-name");
        const newSheetCancelButton = root.querySelector("#new-sheet-cancel");
        const newSheetCreateButton = root.querySelector("#new-sheet-create");
        const confirmModal = root.querySelector("#confirm-modal");
        const confirmMessage = root.querySelector("#confirm-message");
        const confirmCancel = root.querySelector("#confirm-cancel");
        const confirmOk = root.querySelector("#confirm-ok");

        let confirmCallback = null;
        let sheets = {};
        let currentSheet = null;
        let filterPerson = "";
        let filterType = "";
        let filterStatus = "";
        let sortConfig = {
            key: null,
            asc: true
        };

        // === 共通処理 ===
        const showConfirm = (msg, callback) => {
            confirmMessage.textContent = msg;
            confirmCallback = callback;
            confirmModal.style.display = "flex";
        };
        const hideConfirm = () => {
            confirmModal.style.display = "none";
            confirmCallback = null;
        };

        // === シート管理 ===
        const saveSheets = () => localStorage.setItem("toolcheck-sheets", JSON.stringify(sheets));
        const loadSheets = () => sheets = JSON.parse(localStorage.getItem("toolcheck-sheets") || "{}");
        const renderSheetOptions = () => {
            const datalist = document.getElementById("sheet-options");
            if (datalist) datalist.innerHTML = "";
            Object.keys(sheets).forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                if (datalist) datalist.appendChild(opt);
            });
            if (currentSheet && !sheets[currentSheet]) currentSheet = null;
            if (!currentSheet && Object.keys(sheets).length > 0) {
                currentSheet = Object.keys(sheets)[0];
            }
            if (currentSheet) selector.value = currentSheet;
        };
        const createNewSheet = (name) => {
            if (!name || sheets[name]) return false;
            sheets[name] = {
                title: name,
                data: []
            };
            currentSheet = name;
            saveSheets();
            renderSheetOptions();
            renderTable();
            return true;
        };
        const deleteCurrentSheet = () => {
            if (!currentSheet) return;
            delete sheets[currentSheet];
            currentSheet = Object.keys(sheets).length > 0 ? Object.keys(sheets)[0] : null;
            saveSheets();
            renderSheetOptions();
            renderTable();
        };
        const updateSheetTitle = (title) => {
            if (!currentSheet || !sheets[currentSheet]) return;
            sheets[currentSheet].title = title.trim();
            saveSheets();
        };

        // === テーブル描画 ===
        const renderTable = () => {
            const currentSheetData = sheets[currentSheet]?.data || [];

            const filteredData = currentSheetData.filter(item =>
                (!filterPerson || item.person === filterPerson) &&
                (!filterType || item.type === filterType) &&
                (!filterStatus || item.status === filterStatus)
            );

            if (sortConfig.key) {
                filteredData.sort((a, b) => {
                    const valA = a[sortConfig.key] || "";
                    const valB = b[sortConfig.key] || "";
                    return sortConfig.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                });
            }

            titleElem.textContent = sheets[currentSheet]?.title || "新しいチェック表";

            // フィルター更新
            updateFilterOptions("filter-person", currentSheetData.map(d => d.person), filterPerson);
            updateFilterOptions("filter-type", currentSheetData.map(d => d.type), filterType);
            updateSortHeaders();
            updateTableBody(filteredData);
        };

        const updateFilterOptions = (selectId, dataArray, currentValue) => {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = '<option value="">すべて</option>';
<style>
    #toolcheck-app * {
        box-sizing: border-box;
    }

    #toolcheck-app {
        font-family: sans-serif;
        padding: 1em;
        max-width: 1200px;
        margin: auto;
    }

    #toolcheck-app .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1em;
    }

    #toolcheck-app .sheet-title {
        font-size: 1.5em;
        font-weight: bold;
        flex: 1;
    }

    #toolcheck-app .sheet-title[contenteditable] {
        background: #eef;
        padding: 4px;
        border-radius: 4px;
    }

    #toolcheck-app .sheet-controls {
        display: flex;
        gap: 8px;
    }

    #toolcheck-app select,
    #toolcheck-app button {
        padding: 4px 8px;
        font-size: 14px;
    }

    #toolcheck-app .cs-container {
        display: flex;
        flex-direction: column;
        gap: 1em;
    }

    #toolcheck-app .cs-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    #toolcheck-app .cs-table th,
    #toolcheck-app .cs-table td {
        border: 1px solid #ccc;
        padding: 4px;
        font-size: 12px;
        text-align: center;
        word-wrap: break-word;
    }

    #toolcheck-app .cs-table th {
        background-color: #f0f0f0;
    }

    #toolcheck-app .cs-status-未対応 {
        background-color: #fff3cd;
    }

    #toolcheck-app .cs-status-対応中 {
        background-color: #d1ecf1;
    }

    #toolcheck-app .cs-status-完了 {
        background-color: #d4edda;
    }

    #toolcheck-app .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #toolcheck-app .modal-content {
        background: white;
        padding: 1em;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
    }

    #toolcheck-app .modal-content label {
        font-weight: bold;
        display: block;
        margin-top: 0.5em;
    }

    #toolcheck-app .modal-content input,
    #toolcheck-app .modal-content textarea,
    #toolcheck-app .modal-content select {
        width: 100%;
        margin-top: 4px;
        padding: 6px;
    }

    #toolcheck-app .modal-buttons {
        margin-top: 1em;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    #toolcheck-app .cs-btn {
        padding: 4px 8px;
        font-size: 12px;
    }

    #toolcheck-app .history-list span {
        display: inline-block;
        background: #eee;
        margin: 2px;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
    }

    #toolcheck-app .history-list span button {
        margin-left: 4px;
        background: transparent;
        border: none;
        cursor: pointer;
        color: red;
    }

    #toolcheck-app .sheet-selector {
        padding: 6px 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: white;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 250px;
    }

    #toolcheck-app .sheet-combo {
        padding: 6px 30px 6px 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: white;
        width: 250px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M0,0 L6,8 L12,0 Z' fill='%23666'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px 8px;
    }
</style>

<div id="toolcheck-app">
    <div class="header-bar">
        <div id="sheet-title" class="sheet-title" contenteditable="true">新しいチェック表</div>
        <div class="sheet-controls">
            <input type="text" id="sheet-selector" list="sheet-options" class="sheet-combo">
<datalist id="sheet-options"></datalist>
            <button id="sheet-new">＋新規</button>
            <button id="sheet-delete">🗑削除</button>
            <button id="add-entry">予定の追加</button>
            <button id="export-csv">CSV出力</button>
        </div>
    </div>

    <div class="cs-container">
        <div class="filter-bar" style="margin-bottom: 1em;">
            担当者：
            <select id="filter-person">
                <option value="">すべて</option>
            </select>
            項目：
            <select id="filter-type">
                <option value="">すべて</option>
            </select>
            状態：
            <select id="filter-status">
                <option value="">すべて</option>
                <option value="未対応">未対応</option>
                <option value="対応中">対応中</option>
                <option value="完了">完了</option>
            </select>
        </div>
        <table class="cs-table" id="cs-table">
            <thead>
                <tr>
                    <th onclick="sortBy('date')" data-label="日付">日付 ⇅</th>
                    <th onclick="sortBy('person')" data-label="担当者">担当者 ⇅</th>
                    <th onclick="sortBy('type')" data-label="項目">項目 ⇅</th>
                    <th onclick="sortBy('content')" data-label="内容">内容 ⇅</th>
                    <th onclick="sortBy('deadline')" data-label="締切">締切 ⇅</th>
                    <th onclick="sortBy('status')" data-label="状態">状態 ⇅</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="modal" id="entry-modal">
        <div class="modal-content">
            <label>日付<input type="date" id="entry-date"></label>
            <label>担当者<input type="text" id="entry-person" list="person-suggestions"></label>
            <datalist id="person-suggestions"></datalist>
            <div id="person-history" class="history-list"></div>
            <label>項目<input type="text" id="entry-type" list="type-suggestions"></label>
            <datalist id="type-suggestions"></datalist>
            <div id="type-history" class="history-list"></div>
            </label>
            <label>内容<textarea id="entry-content"></textarea></label>
            <label>締切<input type="date" id="entry-deadline"></label>
            <label>状態
                <select id="entry-status">
                    <option>未対応</option>
                    <option>対応中</option>
                    <option>完了</option>
                </select>
            </label>
            <div class="modal-buttons">
                <button id="entry-cancel">閉じる</button>
                <button id="entry-save">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="new-sheet-modal">
        <div class="modal-content">
            <label>新しいチェック表の名前<input type="text" id="new-sheet-name"></label>
            <div class="modal-buttons">
                <button id="new-sheet-cancel">キャンセル</button>
                <button id="new-sheet-create">作成</button>
            </div>
        </div>
    </div>

    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <p id="confirm-message">削除してもよろしいですか？</p>
            <div class="modal-buttons">
                <button id="confirm-cancel">キャンセル</button>
                <button id="confirm-ok">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        // === 共通関数定義 ===
        const getSavedList = (key) => JSON.parse(localStorage.getItem(key) || "[]");
        const saveToList = (key, value) => {
            if (!value) return;
            const list = getSavedList(key);
            if (!list.includes(value)) {
                list.push(value);
                localStorage.setItem(key, JSON.stringify(list));
            }
        };
        const removeFromList = (key, value) => {
            const list = getSavedList(key).filter(v => v !== value);
            localStorage.setItem(key, JSON.stringify(list));
        };
        const renderSuggestions = (key, datalistElem) => {
            if (!datalistElem) return;
            datalistElem.innerHTML = "";
            getSavedList(key).forEach(v => {
                const opt = document.createElement("option");
                opt.value = v;
                datalistElem.appendChild(opt);
            });
        };
        const renderHistory = (key, containerId, suggestionId, inputId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";
            getSavedList(key).forEach(val => {
                const span = document.createElement("span");
                span.textContent = val;
                span.onclick = () => {
                    const input = document.getElementById(inputId);
                    if (input) input.value = val;
                };
                const btn = document.createElement("button");
                btn.textContent = "×";
                btn.onclick = (e) => {
                    e.stopPropagation();
                    removeFromList(key, val);
                    renderHistory(key, containerId, suggestionId, inputId);
                    renderSuggestions(key, document.getElementById(suggestionId));
                };
                span.appendChild(btn);
                container.appendChild(span);
            });
        };

        // === グローバル変数 ===
        const root = document.getElementById("toolcheck-app");
        const modal = root.querySelector("#entry-modal");
        const tableBody = root.querySelector("#cs-table tbody");
        const selector = root.querySelector("#sheet-selector");
        const titleElem = root.querySelector("#sheet-title");
        const newSheetModal = root.querySelector("#new-sheet-modal");
        const newSheetNameInput = root.querySelector("#new-sheet-name");
        const newSheetCancelButton = root.querySelector("#new-sheet-cancel");
        const newSheetCreateButton = root.querySelector("#new-sheet-create");
        const confirmModal = root.querySelector("#confirm-modal");
        const confirmMessage = root.querySelector("#confirm-message");
        const confirmCancel = root.querySelector("#confirm-cancel");
        const confirmOk = root.querySelector("#confirm-ok");

        let confirmCallback = null;
        let sheets = {};
        let currentSheet = null;
        let filterPerson = "";
        let filterType = "";
        let filterStatus = "";
        let sortConfig = {
            key: null,
            asc: true
        };

        // === 共通処理 ===
        const showConfirm = (msg, callback) => {
            confirmMessage.textContent = msg;
            confirmCallback = callback;
            confirmModal.style.display = "flex";
        };
        const hideConfirm = () => {
            confirmModal.style.display = "none";
            confirmCallback = null;
        };

        // === シート管理 ===
        const saveSheets = () => localStorage.setItem("toolcheck-sheets", JSON.stringify(sheets));
        const loadSheets = () => sheets = JSON.parse(localStorage.getItem("toolcheck-sheets") || "{}");
        const renderSheetOptions = () => {
            const datalist = document.getElementById("sheet-options");
            if (datalist) datalist.innerHTML = "";
            Object.keys(sheets).forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                if (datalist) datalist.appendChild(opt);
            });
            if (currentSheet && !sheets[currentSheet]) currentSheet = null;
            if (!currentSheet && Object.keys(sheets).length > 0) {
                currentSheet = Object.keys(sheets)[0];
            }
            if (currentSheet) selector.value = currentSheet;
        };
        const createNewSheet = (name) => {
            if (!name || sheets[name]) return false;
            sheets[name] = {
                title: name,
                data: []
            };
            currentSheet = name;
            saveSheets();
            renderSheetOptions();
            renderTable();
            return true;
        };
        const deleteCurrentSheet = () => {
            if (!currentSheet) return;
            delete sheets[currentSheet];
            currentSheet = Object.keys(sheets).length > 0 ? Object.keys(sheets)[0] : null;
            saveSheets();
            renderSheetOptions();
            renderTable();
        };
        const updateSheetTitle = (title) => {
            if (!currentSheet || !sheets[currentSheet]) return;
            sheets[currentSheet].title = title.trim();
            saveSheets();
        };

        // === テーブル描画 ===
        const renderTable = () => {
            const currentSheetData = sheets[currentSheet]?.data || [];

            const filteredData = currentSheetData.filter(item =>
                (!filterPerson || item.person === filterPerson) &&
                (!filterType || item.type === filterType) &&
                (!filterStatus || item.status === filterStatus)
            );

            if (sortConfig.key) {
                filteredData.sort((a, b) => {
                    const valA = a[sortConfig.key] || "";
                    const valB = b[sortConfig.key] || "";
                    return sortConfig.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                });
            }

            titleElem.textContent = sheets[currentSheet]?.title || "新しいチェック表";

            // フィルター更新
            updateFilterOptions("filter-person", currentSheetData.map(d => d.person), filterPerson);
            updateFilterOptions("filter-type", currentSheetData.map(d => d.type), filterType);
            updateSortHeaders();
            updateTableBody(filteredData);
        };

        const updateFilterOptions = (selectId, dataArray, currentValue) => {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = '<option value="">すべて</option>';
            const uniqueValues = [...new Set(dataArray)].sort(); // 重複排除してソート
            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                if (value === currentValue) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        };

        const updateSortHeaders = () => {
            const headers = document.querySelectorAll('#cs-table th');
            headers.forEach(header => {
                const key = header.getAttribute('onclick').split("'")[1];
                if (key === sortConfig.key) {
                    header.textContent = header.dataset.label + (sortConfig.asc ? ' ↑' : ' ↓');
                } else {
                    header.textContent = header.dataset.label + ' ⇅';
                }
            });
        };

        const updateTableBody = (dataArray) =>
{
            let tableHTML = '';
            dataArray.forEach(item => {
                tableHTML += `
                    <tr class="cs-row">
                        <td>${item.date}</td>
                        <td>${item.person}</td>
                        <td>${item.type}</td>
                        <td>${item.content}</td>
                        <td>${item.deadline}</td>
                        <td class="cs-status-${item.status}">${item.status}</td>
                        <td>
                            <button class="cs-btn edit-btn" data-id="${item.id}">編集</button>
                            <button class="cs-btn delete-btn" data-id="${item.id}">削除</button>
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = tableHTML;
        };

        // === イベントハンドラ ===
        const setupEventListeners = () => {
            root.querySelector("#add-entry").addEventListener("click", () => {
                modal.style.display = "flex";
                clearEntryModal();
            });

            root.querySelector("#entry-cancel").addEventListener("click", () => {
                modal.style.display = "none";
            });

            root.querySelector("#entry-save").addEventListener("click", () => {
                saveEntry();
                modal.style.display = "none";
            });

            tableBody.addEventListener("click", (e) => {
                if (e.target.classList.contains("delete-btn")) {
                    const id = e.target.dataset.id;
                    showConfirm("この予定を削除しますか？", () => {
                        deleteEntry(id);
                        hideConfirm();
                    });
                } else if (e.target.classList.contains("edit-btn")) {
                    const id = e.target.dataset.id;
                    editEntry(id);
                    modal.style.display = "flex";
                }
            });

            selector.addEventListener("change", () => {
                currentSheet = selector.value;
                renderTable();
            });

            titleElem.addEventListener("input", () => {
                updateSheetTitle(titleElem.textContent);
            });

            root.querySelector("#sheet-new").addEventListener("click", () => {
                newSheetModal.style.display = "flex";
            });

            newSheetCancelButton.addEventListener("click", () => {
                newSheetModal.style.display = "none";
            });

            newSheetCreateButton.addEventListener("click", () => {
                if (createNewSheet(newSheetNameInput.value)) {
                    newSheetModal.style.display = "none";
                    newSheetNameInput.value = "";
                } else {
                    alert("同じ名前のシートが既に存在します。");
                }
            });

            root.querySelector("#sheet-delete").addEventListener("click", () => {
                if (!currentSheet) return;
                showConfirm("現在のシートを削除しますか？", () => {
                    deleteCurrentSheet();
                    hideConfirm();
                });
            });

            confirmCancel.addEventListener("click", hideConfirm);
            confirmOk.addEventListener("click", () => {
                if (confirmCallback) confirmCallback();
            });

            root.querySelector("#filter-person").addEventListener("change", (e) => {
                filterPerson = e.target.value;
                renderTable();
            });

            root.querySelector("#filter-type").addEventListener("change", (e) => {
                filterType = e.target.value;
                renderTable();
            });

            root.querySelector("#filter-status").addEventListener("change", (e) => {
                filterStatus = e.target.value;
                renderTable();
            });

            root.querySelector("#export-csv").addEventListener("click", exportToCSV);
        };

        // === エントリー処理 ===
        const clearEntryModal = () => {
            root.querySelector("#entry-date").value = "";
            root.querySelector("#entry-person").value = "";
            root.querySelector("#entry-type").value = "";
            root.querySelector("#entry-content").value = "";
            root.querySelector("#entry-deadline").value = "";
            root.querySelector("#entry-status").value = "未対応";
            root.querySelector("#entry-save").dataset.id = "";
        };

        const saveEntry = () => {
            if (!currentSheet) return;

            const entry = {
                id: root.querySelector("#entry-save").dataset.id || String(Date.now()),
                date: root.querySelector("#entry-date").value,
                person: root.querySelector("#entry-person").value,
                type: root.querySelector("#entry-type").value,
                content: root.querySelector("#entry-content").value,
                deadline: root.querySelector("#entry-deadline").value,
                status: root.querySelector("#entry-status").value
            };

            const sheetData = sheets[currentSheet].data;
            const existingIndex = sheetData.findIndex(item => item.id === entry.id);

            if (existingIndex > -1) {
                sheetData.splice(existingIndex, 1, entry); // Update existing
            } else {
                sheetData.push(entry); // Add new
            }

            sheets[currentSheet].data = sheetData;
            saveSheets();

            saveToList("toolcheck-persons", entry.person);
            saveToList("toolcheck-types", entry.type);

            renderSuggestions("toolcheck-persons", document.getElementById("person-suggestions"));
            renderSuggestions("toolcheck-types", document.getElementById("type-suggestions"));
            renderHistory("toolcheck-persons", "person-history", "person-suggestions", "entry-person");
            renderHistory("toolcheck-types", "type-history", "type-suggestions", "entry-type");

            renderTable();
        };

        const deleteEntry = (id) => {
            if (!currentSheet) return;
            sheets[currentSheet].data = sheets[currentSheet].data.filter(item => item.id !== id);
            saveSheets();
            renderTable();
        };

        const editEntry = (id) => {
            if (!currentSheet) return;
            const entry = sheets[currentSheet].data.find(item => item.id === id);
            if (entry) {
                root.querySelector("#entry-date").value = entry.date;
                root.querySelector("#entry-person").value = entry.person;
                root.querySelector("#entry-type").value = entry.type;
                root.querySelector("#entry-content").value = entry.content;
                root.querySelector("#entry-deadline").value = entry.deadline;
                root.querySelector("#entry-status").value = entry.status;
                root.querySelector("#entry-save").dataset.id = entry.id;
            }
        };

        // === ソート処理 ===
        const sortBy = (key) => {
            if (sortConfig.key === key) {
                sortConfig.asc = !sortConfig.asc;
            } else {
                sortConfig.key = key;
                sortConfig.asc = true;
            }
            renderTable();
        };

        // === CSV出力 ===
        const exportToCSV = () => {
            if (!currentSheet || sheets[currentSheet].data.length === 0) {
                alert("エクスポートするデータがありません。");
                return;
            }

            const csvRows = [];
            const headers = Object.keys(sheets[currentSheet].data[0]).join(',');
            csvRows.push(headers);

            sheets[currentSheet].data.forEach(row => {
                const values = Object.values(row).map(value => `"${value}"`).join(',');
                csvRows.push(values);
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // BOMを付与
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${sheets[currentSheet].title}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // === 初期化 ===
        const init = () => {
            loadSheets();
            renderSheetOptions();
            setupEventListeners();
            renderSuggestions("toolcheck-types", document.getElementById("type-suggestions"));
            renderSuggestions("toolcheck-persons", document.getElementById("person-suggestions"));
            renderHistory("toolcheck-types", "type-history", "type-suggestions", "entry-type");
            renderHistory("toolcheck-persons", "person-history", "person-suggestions", "entry-person");
            renderTable();
        };

        init();
    })();
</script>
